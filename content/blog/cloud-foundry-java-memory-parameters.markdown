---
Categories:
- Development
- CloudFoundry
Description: "How to set Java memory parameters for a Cloud Foundry application."
Tags:
- Development
- golang
date: 2015-05-20T19:42:56-07:00
menu: main
title: Configuring Cloud Foundry Java Memory Parameters
---
This week I have been trying out Cloud Foundry. Today while trying to set up monitoring through AppDynamics, the sample application that I was using started crashing because of a Java memory error. This is what was in the Cloud Foundry logs.

```bash
May 20 18:14:51 CloudFoundry 6767b9fd-1874-43cb-a4f8-7470a17c90ae/[App/2]:  /bin/bash: line 31:    32 Killed                  ( SERVER_PORT=$PORT $PWD/.java-buildpack/open_jdk_jre/bin/java -cp $PWD/.:$PWD/.java-buildpack/spring_auto_reconfiguration/spring_auto_reconfiguration-1.4.0_RELEASE.jar -Djava.io.tmpdir=$TMPDIR -XX:OnOutOfMemoryError=$PWD/.java-buildpack/open_jdk_jre/bin/killjava.sh -Xmx499200K -Xms499200K -XX:MaxPermSize=65M -XX:PermSize=65M -Xss1M -javaagent:$PWD/.java-buildpack/app_dynamics_agent/javaagent.jar -Dappdynamics.agent.applicationName='******' -Dappdynamics.agent.tierName='******' -Dappdynamics.agent.nodeName=$(expr "$VCAP_APPLICATION" : '.*instance_id[": ]*"\([a-z0-9]\+\)".*') -Dappdynamics.agent.accountAccessKey=****** -Dappdynamics.agent.accountName=******* -Dappdynamics.controller.hostName=******.saas.appdynamics.com -Dappdynamics.controller.port=443 -Dappdynamics.controller.ssl.enabled=true org.springframework.boot.loader.JarLauncher )
```

It can be seen that the `MaxPermSize` is set to `65M`. Now, this is not something I configured for this app. This value was assigned by the Java build pack generated by Cloud Foundry when the app was deployed. The only way to change this value is to change the configurations of the Java build pack. There are two ways to do this:

1. Fork the [Java build pack](https://github.com/cloudfoundry/java-buildpack), modify the default memory parameters and use this build pack.
1. Override the memory parameters used by the build pack.

Option 1 seems to be an overkill and Cloud Foundry provides a [relatively easy method](https://github.com/cloudfoundry/java-buildpack/blob/master/README.md#configuration-and-extension) to override build pack parameters. Option 2 is the approach I decided to take.

There are [two sets of mappings](https://github.com/cloudfoundry/java-buildpack/blob/master/docs/jre-open_jdk_jre.md) that control the various Java memory configurations - `memory_sizes` and `memory_heuristics`. Together, these two parameters provide a lot of [flexibility](https://github.com/cloudfoundry/java-buildpack/blob/master/docs/jre-open_jdk_jre.md#memory-calculation) to control memory allocation. For the particular issue my application faced, all I need to do is to force an appropriate value for `MaxPermSize` and this can be done by setting the `JBP_CONFIG_OPEN_JDK_JRE` environment variable as:

```bash
cf set-env app-name JBP_CONFIG_OPEN_JDK_JRE '[memory_sizes: {permgen: 128m}]'
```

While this configurations works for applications running under Java `1.7`, the right parameter to use for applications running under Java `1.8` is `metaspace`.

```bash
cf set-env app-name JBP_CONFIG_OPEN_JDK_JRE '[memory_sizes: {metaspace: 128m}]'
```

After re-staging the application and making sure the application works as expected, I added this environment variable to the application's `manifest.yml` file.

```yaml
---
applications:
- name: test-app
  ...
  env:
    JBP_CONFIG_OPEN_JDK_JRE: '[memory_sizes: {permgen: 128m}]'
  ...
```

To see how to adjust the memory parameters by modifying the Java build pack, see Haydon Ryan's blog post [here](http://www.haydonryan.com/java-8-increasing-metaspace-size-in-cloud-foundry/).
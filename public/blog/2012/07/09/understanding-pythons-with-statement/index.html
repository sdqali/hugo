<!DOCTYPE html5>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us" prefix="og: http://ogp.me/ns#">
  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Understanding Python&#39;s &#34;with&#34; statement</title>

    
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    
    <link href="/css/clean-blog.min.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">

    
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    
    
    

</head>

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@sdqali">
  <meta name="twitter:creator" content="@sdqali">
  <meta name="twitter:title" content="Understanding Python&#39;s &#34;with&#34; statement">
  <meta name="twitter:description" content="What is it?

Python&rsquo;s with statement provides a very convenient way of dealing with the situation where you have to do a setup and teardown to make something happen. A very good example for this is the situation where you want to gain a handler to a file, read data from the file and the close the file handler.

Without the with statement, one would write something along the lines of:
file = open(&quot;/tmp/foo.txt&quot;)
data = file.read()
file.close()


There are two annoying things here. First, you end up forgetting to close the file handler. The second is how to handle exceptions that may occur once the file handler has been obtained. One could write something like this to get around this:
file = open(&quot;/tmp/foo.txt&quot;)
try:
    data = file.read()
finally:
    file.close()


While this works well, it is unnecessarily verbose. This is where with is useful. The good thing about with apart from the better syntax is that it is very good handling exceptions. The above code would look like this, when using with:
with open(&quot;/tmp/foo.txt&quot;) as file:
   data = file.read()

">
  <meta name="twitter:image" content="http://sdqali.in/map[feature:/images/threaded-blue-on-black-cropped.jpg]">

  <meta property="og:title" content="Understanding Python&#39;s &#34;with&#34; statement" />
  <meta property="og:description" content="What is it?

Python&rsquo;s with statement provides a very convenient way of dealing with the situation where you have to do a setup and teardown to make something happen. A very good example for this is the situation where you want to gain a handler to a file, read data from the file and the close the file handler.

Without the with statement, one would write something along the lines of:
file = open(&quot;/tmp/foo.txt&quot;)
data = file.read()
file.close()


There are two annoying things here. First, you end up forgetting to close the file handler. The second is how to handle exceptions that may occur once the file handler has been obtained. One could write something like this to get around this:
file = open(&quot;/tmp/foo.txt&quot;)
try:
    data = file.read()
finally:
    file.close()


While this works well, it is unnecessarily verbose. This is where with is useful. The good thing about with apart from the better syntax is that it is very good handling exceptions. The above code would look like this, when using with:
with open(&quot;/tmp/foo.txt&quot;) as file:
   data = file.read()

" itemprop="description"/>
  <meta property="og:url" content="http://sdqali.in/blog/2012/07/09/understanding-pythons-with-statement/" />
  <meta property="og:image" content="http://sdqali.in/map[feature:/images/threaded-blue-on-black-cropped.jpg]" />
  <body>

    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Sadique Ali</a>
    </div>

    
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/">Home</a> </li>
        <li><a href="/blog/">Blog</a> </li>
        <li><a href="/about">About</a> </li>
        <li><a href="https://github.com/sdqali">GitHub</a> </li>
        <li><a href="https://twitter.com/sdqali">Twitter</a> </li>
        <li><a href="https://www.linkedin.com/in/sdqali">LinkedIn</a> </li>
      </ul>
    </div>
    
  </div>
  
</nav>




    
    
    <header class="intro-header">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="site-heading">
              <h1> Understanding Python&#39;s &#34;with&#34; statement</h1>
              <span class="meta">Mon, Jul 9, 2012</span>
            </div>
          </div>
        </div>
      </div>
    </header>


    
    <article>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            

<h2 id="what-is-it:ac4d2c4b2f71b3b47d24799d64503bb3">What is it?</h2>

<p>Python&rsquo;s <code>with</code> statement provides a very convenient way of dealing with the situation where you have to do a setup and teardown to make something happen. A very good example for this is the situation where you want to gain a handler to a file, read data from the file and the close the file handler.</p>

<p>Without the <code>with</code> statement, one would write something along the lines of:</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #336666">file</span> <span style="color: #555555">=</span> <span style="color: #336666">open</span>(<span style="color: #CC3300">&quot;/tmp/foo.txt&quot;</span>)
data <span style="color: #555555">=</span> <span style="color: #336666">file</span><span style="color: #555555">.</span>read()
<span style="color: #336666">file</span><span style="color: #555555">.</span>close()
</pre></div>

<p>There are two annoying things here. First, you end up forgetting to close the file handler. The second is how to handle exceptions that may occur once the file handler has been obtained. One could write something like this to get around this:</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #336666">file</span> <span style="color: #555555">=</span> <span style="color: #336666">open</span>(<span style="color: #CC3300">&quot;/tmp/foo.txt&quot;</span>)
<span style="color: #006699; font-weight: bold">try</span>:
    data <span style="color: #555555">=</span> <span style="color: #336666">file</span><span style="color: #555555">.</span>read()
<span style="color: #006699; font-weight: bold">finally</span>:
    <span style="color: #336666">file</span><span style="color: #555555">.</span>close()
</pre></div>

<p>While this works well, it is unnecessarily verbose. This is where <code>with</code> is useful. The good thing about <code>with</code> apart from the better syntax is that it is very good handling exceptions. The above code would look like this, when using <code>with</code>:</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #006699; font-weight: bold">with</span> <span style="color: #336666">open</span>(<span style="color: #CC3300">&quot;/tmp/foo.txt&quot;</span>) <span style="color: #006699; font-weight: bold">as</span> <span style="color: #336666">file</span>:
   data <span style="color: #555555">=</span> <span style="color: #336666">file</span><span style="color: #555555">.</span>read()
</pre></div>

<h2 id="how-does-it-work:ac4d2c4b2f71b3b47d24799d64503bb3">How does it work?</h2>

<p>While this might look like magic, the way Python handles <code>with</code> is more clever than magic. The basic idea is that the statement after <code>with</code> has to evaluate an object that responds to an <code>__enter__()</code> as well as an <code>__exit__()</code> function.</p>

<p>After the statement that follows <code>with</code> is evaluated, the <code>__enter__()</code> function on the resulting object is called. The value returned by this function is assigned to the variable following <code>as</code>. After every statement in the block is evaluated, the <code>__exit__()</code> function is called.</p>

<p>This can be demonstrated with the following example:</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #0099FF; font-style: italic">#!/usr/bin/env python</span>
<span style="color: #0099FF; font-style: italic"># with_example01.py</span>


<span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">Sample</span>:
    <span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">__enter__</span>(<span style="color: #336666">self</span>):
        <span style="color: #006699; font-weight: bold">print</span> <span style="color: #CC3300">&quot;In __enter__()&quot;</span>
        <span style="color: #006699; font-weight: bold">return</span> <span style="color: #CC3300">&quot;Foo&quot;</span>

    <span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">__exit__</span>(<span style="color: #336666">self</span>, <span style="color: #336666">type</span>, value, trace):
        <span style="color: #006699; font-weight: bold">print</span> <span style="color: #CC3300">&quot;In __exit__()&quot;</span>


<span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">get_sample</span>():
    <span style="color: #006699; font-weight: bold">return</span> Sample()


<span style="color: #006699; font-weight: bold">with</span> get_sample() <span style="color: #006699; font-weight: bold">as</span> sample:
    <span style="color: #006699; font-weight: bold">print</span> <span style="color: #CC3300">&quot;sample:&quot;</span>, sample
</pre></div>

<p>When executed, this will result in:</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>bash-3.2$ ./with_example01.py
In __enter__<span style="color: #555555">()</span>
sample: Foo
In __exit__<span style="color: #555555">()</span>
</pre></div>

<p>As you can see,</p>

<ol>
<li>The <code>__enter__()</code> function is executed</li>
<li>The value returned by it - in this case <code>&quot;Foo&quot;</code> is assigned to <code>sample</code></li>
<li>The body of the block is executed, thereby printing the value of <code>sample</code> ie. <code>&quot;Foo&quot;</code></li>
<li>The <code>__exit__()</code> function is called.</li>
</ol>

<p>What makes <code>with</code> really powerful is the fact that it can handle exceptions. You would have noticed that the <code>__exit__()</code> function for <code>Sample</code> takes three arguments - <code>val</code>, <code>type</code> and <code>trace</code>. These are useful in exception handling. Let&rsquo;s see how this works by modifying the above example.</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #0099FF; font-style: italic">#!/usr/bin/env python</span>
<span style="color: #0099FF; font-style: italic"># with_example02.py</span>


<span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">Sample</span>:
    <span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">__enter__</span>(<span style="color: #336666">self</span>):
        <span style="color: #006699; font-weight: bold">return</span> <span style="color: #336666">self</span>

    <span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">__exit__</span>(<span style="color: #336666">self</span>, <span style="color: #336666">type</span>, value, trace):
        <span style="color: #006699; font-weight: bold">print</span> <span style="color: #CC3300">&quot;type:&quot;</span>, <span style="color: #336666">type</span>
        <span style="color: #006699; font-weight: bold">print</span> <span style="color: #CC3300">&quot;value:&quot;</span>, value
        <span style="color: #006699; font-weight: bold">print</span> <span style="color: #CC3300">&quot;trace:&quot;</span>, trace

    <span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">do_something</span>(<span style="color: #336666">self</span>):
        bar <span style="color: #555555">=</span> <span style="color: #FF6600">1</span><span style="color: #555555">/</span><span style="color: #FF6600">0</span>
        <span style="color: #006699; font-weight: bold">return</span> bar <span style="color: #555555">+</span> <span style="color: #FF6600">10</span>

<span style="color: #006699; font-weight: bold">with</span> Sample() <span style="color: #006699; font-weight: bold">as</span> sample:
    sample<span style="color: #555555">.</span>do_something()
</pre></div>

<p>Notice how in this example, instead of <code>get_sample()</code>, <code>with</code> takes <code>Sample()</code>. It does not matter, as long as the statement that follows <code>with</code> evaluates to an object that has an <code>__enter__()</code> and <code>__exit__()</code> functions. In this case, <code>Sample()</code>&rsquo;s <code>__enter__()</code> returns the newly created instance of <code>Sample</code> and that is what gets passed to <code>sample</code>.</p>

<p>When executed:</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>bash-3.2$ ./with_example02.py
type: &lt;<span style="color: #336666">type</span> <span style="color: #CC3300">&#39;exceptions.ZeroDivisionError&#39;</span>&gt;
value: integer division or modulo by zero
trace: &lt;traceback object at 0x1004a8128&gt;
Traceback <span style="color: #555555">(</span>most recent call last<span style="color: #555555">)</span>:
  File <span style="color: #CC3300">&quot;./with_example02.py&quot;</span>, line 19, in &lt;module&gt;
    sample.do_something<span style="color: #555555">()</span>
  File <span style="color: #CC3300">&quot;./with_example02.py&quot;</span>, line 15, in do_something
    <span style="color: #003333">bar</span> <span style="color: #555555">=</span> 1/0
ZeroDivisionError: integer division or modulo by zero
</pre></div>

<p>Essentially, if there are exceptions being thrown from anywhere inside the block, the <code>__exit__()</code> function for the object is called. As you can see, the type, value and the stack trace associated with the exception thrown is passed to this function. In this case, you can see that there was a <code>ZeroDivisionError</code> exception being thrown. People implementing libraries can write code that clean up resources, close files etc. in their <code>__exit__()</code> functions.</p>

<p>Thus, Python&rsquo;s <code>with</code> is a nifty construct that makes code a little less verbose and makes cleaning up during exceptions a bit easier.</p>

<p>I have put the code examples given here on <a href="https://github.com/sdqali/python_dojo/tree/master/with">Github</a>.</p>

          </div>
        </div>
      </div>
    </article>

    <hr>

    
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          <li>
            <a href="https://twitter.com/sdqali">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="https://linkedin.com/in/sdqali">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="https://github.com/sdqali">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
        </ul>
        <p class="copyright text-muted">&copy; All rights reserved.</p>
      </div>
    </div>
  </div>
</footer>


<script src="/js/jquery.js"></script>


<script src="/js/bootstrap.min.js"></script>


<script src="/js/clean-blog.min.js"></script>

  </body>
</html>

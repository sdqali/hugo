<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> Configuring Cloud Foundry Java Memory Parameters &middot; Sadique Ali </title>

  
  <link rel="stylesheet" href="http://localhost:1313//css/poole.css">
  <link rel="stylesheet" href="http://localhost:1313//css/syntax.css">
  <link rel="stylesheet" href="http://localhost:1313//css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Sadique Ali" />
</head>

<body class="theme-base-0b">

<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
	<a href="/">Sadique Ali</a>
      </h1>
      <p class="lead">
       A blog about the Code I write and the Technologies I use. And other things that interest me. 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="/">Home</a> </li>
      <li><a href="/blog/">Blog</a> </li>
      <li><a href="/about">About</a> </li>
      <li><a href="https://github.com/sdqali">GitHub</a> </li>
      <li><a href="https://twitter.com/sdqali">Twitter</a> </li>
      <li><a href="https://www.linkedin.com/in/sdqali">LinkedIn</a> </li>
      
    </ul>

    <p>&copy; 2015. All rights reserved. </p>
  </div>
</div>


    <div class="content container">
<div class="post">
  <h1>Configuring Cloud Foundry Java Memory Parameters</h1>
  <span class="post-date">Wed, May 20, 2015</span>
      <p>This week I have been trying out Cloud Foundry. Today while trying to set up monitoring through AppDynamics, the sample application that I was using started crashing because of a Java memory error. This blog post discusses how to prevent this from happening by configuring Java memory parameters used by the application.</p>

<p>This is what was in the Cloud Foundry logs.</p>

<pre><code class="language-bash">May 20 18:14:51 CloudFoundry 6767b9fd-1874-43cb-a4f8-7470a17c90ae/[App/2]:  /bin/bash: line 31:    32 Killed                  ( SERVER_PORT=$PORT $PWD/.java-buildpack/open_jdk_jre/bin/java -cp $PWD/.:$PWD/.java-buildpack/spring_auto_reconfiguration/spring_auto_reconfiguration-1.4.0_RELEASE.jar -Djava.io.tmpdir=$TMPDIR -XX:OnOutOfMemoryError=$PWD/.java-buildpack/open_jdk_jre/bin/killjava.sh -Xmx499200K -Xms499200K -XX:MaxPermSize=65M -XX:PermSize=65M -Xss1M -javaagent:$PWD/.java-buildpack/app_dynamics_agent/javaagent.jar -Dappdynamics.agent.applicationName='******' -Dappdynamics.agent.tierName='******' -Dappdynamics.agent.nodeName=$(expr &quot;$VCAP_APPLICATION&quot; : '.*instance_id[&quot;: ]*&quot;\([a-z0-9]\+\)&quot;.*') -Dappdynamics.agent.accountAccessKey=****** -Dappdynamics.agent.accountName=******* -Dappdynamics.controller.hostName=******.saas.appdynamics.com -Dappdynamics.controller.port=443 -Dappdynamics.controller.ssl.enabled=true org.springframework.boot.loader.JarLauncher )
</code></pre>

<p>It can be seen that the <code>MaxPermSize</code> is set to <code>65M</code>. Now, this is not something I configured for this app. This value was assigned by the Java build pack generated by Cloud Foundry when the app was deployed. The only way to change this value is to change the configurations of the Java build pack. There are two ways to do this:</p>

<ol>
<li>Fork the <a href="https://github.com/cloudfoundry/java-buildpack">Java build pack</a>, modify the default memory parameters and use this build pack.</li>
<li>Override the memory parameters used by the build pack.</li>
</ol>

<p>Option 1 seems to be an overkill and Cloud Foundry provides a <a href="https://github.com/cloudfoundry/java-buildpack/blob/master/README.md#configuration-and-extension">relatively easy method</a> to override build pack parameters. Option 2 is the approach I decided to take.</p>

<p>There are <a href="https://github.com/cloudfoundry/java-buildpack/blob/master/docs/jre-open_jdk_jre.md">two sets of mappings</a> that control the various Java memory configurations - <code>memory_sizes</code> and <code>memory_heuristics</code>. Together, these two parameters provide a lot of <a href="https://github.com/cloudfoundry/java-buildpack/blob/master/docs/jre-open_jdk_jre.md#memory-calculation">flexibility</a> to control memory allocation. For the particular issue my application faced, all I need to do is to force an appropriate value for <code>MaxPermSize</code> and this can be done by setting the <code>JBP_CONFIG_OPEN_JDK_JRE</code> environment variable as:</p>

<pre><code class="language-bash">cf set-env app-name JBP_CONFIG_OPEN_JDK_JRE '[memory_sizes: {permgen: 128m}]'
</code></pre>

<p>While this configurations works for applications running under Java <code>1.7</code>, the right parameter to use for applications running under Java <code>1.8</code> is <code>metaspace</code>.</p>

<pre><code class="language-bash">cf set-env app-name JBP_CONFIG_OPEN_JDK_JRE '[memory_sizes: {metaspace: 128m}]'
</code></pre>

<p>After re-staging the application and making sure the application works as expected, I added this environment variable to the application&rsquo;s <code>manifest.yml</code> file.</p>

<pre><code class="language-yaml">---
applications:
- name: test-app
  ...
  env:
    JBP_CONFIG_OPEN_JDK_JRE: '[memory_sizes: {permgen: 128m}]'
  ...
</code></pre>

<p>To see how to adjust the memory parameters by modifying the Java build pack, see Haydon Ryan&rsquo;s blog post <a href="http://www.haydonryan.com/java-8-increasing-metaspace-size-in-cloud-foundry/">here</a>.</p>

</div>
</div>

  <script>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>

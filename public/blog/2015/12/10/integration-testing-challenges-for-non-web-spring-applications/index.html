<!DOCTYPE html5>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us" prefix="og: http://ogp.me/ns#">
  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Integration testing challenges for non-web Spring applications</title>

    
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    
    <link href="/css/clean-blog.min.css" rel="stylesheet">

    
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    
    
    

</head>

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@sdqali">
  <meta name="twitter:creator" content="@sdqali">
  <meta name="twitter:title" content="Integration testing challenges for non-web Spring applications">
  <meta name="twitter:description" content="We are building a command line data loader application at work that uses Spring. One of the things that I took us more time that it should have to figure out was how to write an integration test that invokes the command line application with the right command line arguments. This blog post describes this scenario and a potential solution to this problem.
">
  <meta name="twitter:image" content="http://sdqali.in/images/spring-by-pivotal.png">

  <meta property="og:title" content="Integration testing challenges for non-web Spring applications" />
  <meta property="og:description" content="We are building a command line data loader application at work that uses Spring. One of the things that I took us more time that it should have to figure out was how to write an integration test that invokes the command line application with the right command line arguments. This blog post describes this scenario and a potential solution to this problem.
" itemprop="description"/>
  <meta property="og:url" content="http://sdqali.in/blog/2015/12/10/integration-testing-challenges-for-non-web-spring-applications/" />
  <meta property="og:image" content="http://sdqali.in/images/spring-by-pivotal.png" />
  <body>

    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Sadique Ali</a>
    </div>

    
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/">Home</a> </li>
        <li><a href="/blog/">Blog</a> </li>
        <li><a href="/about">About</a> </li>
        <li><a href="https://github.com/sdqali">GitHub</a> </li>
        <li><a href="https://twitter.com/sdqali">Twitter</a> </li>
        <li><a href="https://www.linkedin.com/in/sdqali">LinkedIn</a> </li>
      </ul>
    </div>
    
  </div>
  
</nav>




    
    
    <header class="intro-header" style="background-image: url('/img/home-bg.jpg')">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="site-heading">
              <h1> Integration testing challenges for non-web Spring applications</h1>
              <span class="meta">Thu, Dec 10, 2015</span>
            </div>
          </div>
        </div>
      </div>
    </header>


    
    <article>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <p>We are building a command line data loader application at work that uses Spring. One of the things that I took us more time that it should have to figure out was how to write an integration test that invokes the command line application with the right command line arguments. This blog post describes this scenario and a potential solution to this problem.</p>

<p>Let&rsquo;s consider a simple command line application implemented using Spring Boot&rsquo;s <code>CommandLineRunner</code>. The main application class is fairly simple.</p>

<pre><code class="language-java">
@Configuration
@EnableAutoConfiguration
@ComponentScan
public class Application implements CommandLineRunner {
    @Autowired
    DataService dataService;

    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }

    @Override
    public void run(String... args) {
        dataService.perform(args[0]);
    }
}
</code></pre>

<p>In addition to this, there is a configuration class <code>AppConfiguration</code>.</p>

<pre><code class="language-java">@Configuration
public class AppConfiguration {
    @Bean
    public DataService dataService() {
        return new DataService();
    }
}
</code></pre>

<p>The <code>DataService</code> simply prints the argument it receives.</p>

<pre><code class="language-java">public class DataService {
    public void perform(String arg) {
        System.out.println(arg);
    }
}
</code></pre>

<p>If we were to attempt writing an integration test for this application, it would look like this:</p>

<pre><code class="language-java">@RunWith(SpringJUnit4ClassRunner.class)
@SpringApplicationConfiguration(classes = {Application.class})
public class ApplicationIntegrationTest {
    @Autowired
    private Application application;


    @Rule
    public OutputCapture outputCapture = new OutputCapture();

    @Test
    public void shouldGenerateResultFiles() throws Exception {
        application.run(&quot;sampleOutPut&quot;);
        assertTrue(outputCapture.toString().contains(&quot;sampleOutput&quot;));
    }
}
</code></pre>

<p>That test is straightforward—it loads the Spring context with all the beans, runs the application with parameters and expects the parameter to be printed to the console.</p>

<p>Except, it does not work. If we were to execute the above test, we will get the following error:</p>

<pre><code class="language-bash">...
Caused by: java.lang.ArrayIndexOutOfBoundsException: 0
at in.sdqali.springapps.Application.run(Application.java:24) ~[main/:na]
...
</code></pre>

<p>What happened? It looks like the <code>run</code> method was called with out any arguments while the test configuration was loaded.</p>

<p>Let‘s try and understand wh
y this happens. Remember how we annotated the test with <code>@SpringApplicationConfiguration</code>? This annotation is a meta-annotation <sup class="footnote-ref" id="fnref:1944f35ca6adb86a80e399600f75145d:1"><a rel="footnote" href="#fn:1944f35ca6adb86a80e399600f75145d:1">1</a></sup> specified as:</p>

<pre><code class="language-java">@ContextConfiguration(loader = SpringApplicationContextLoader.class)
@Documented
@Inherited
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.TYPE)
public @interface SpringApplicationConfiguration {
...
}
</code></pre>

<p><code>ContextConfiguration</code> is an annotation that allows tests to specify the information used to load and configure the application context. From the Java doc for this annotation:</p>

<pre><code> * {@code @ContextConfiguration} defines class-level metadata that is used to determine
 * how to load and configure an {@link org.springframework.context.ApplicationContext
 * ApplicationContext} for integration tests.
</code></pre>

<p>This brings us to <code>SpringApplicationContextLoader</code>‘s <code>loadContext</code> method and buried deep inside are these line:</p>

<pre><code class="language-java">application.setInitializers(initializers);
ConfigurableApplicationContext applicationContext = application.run();
return applicationContext;
</code></pre>

<p>So, regardless of how many arguments our command line application was supposed to take, this loader always call the application without any arguments.</p>

<p>There are two solutions I have been able to think of for this problem:</p>

<ul>
<li>Override the<code>SpringApplicationContextLoader</code> and pass the necessary arguments in <code>application.run()</code>. This is definitely not an elegant or easy solution.</li>
<li>Use an environment variable instead of the command line argument as the input to the service. This will allow us to inject this variable using the <code>@IntegrationTest</code> annotation.</li>
</ul>

<p>My next blog post will discuss the second approach.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1944f35ca6adb86a80e399600f75145d:1">Meta annotations. <a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/beans.html#beans-meta-annotations">Spring documentation</a>. To see how to use meta-annotations to write custom annoations, see <a href="/blog/2015/12/06/implementing-custom-annotations-for-spring-mvc/">this blog post</a>.
 <a class="footnote-return" href="#fnref:1944f35ca6adb86a80e399600f75145d:1"><sup>[return]</sup></a></li>
</ol>
</div>

          </div>
        </div>
      </div>
    </article>

    <hr>

    
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          <li>
            <a href="#">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="#">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="#">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
        </ul>
        <p class="copyright text-muted">&copy; . All rights reserved. </p>
      </div>
    </div>
  </div>
</footer>


<script src="/js/jquery.js"></script>


<script src="/js/bootstrap.min.js"></script>


<script src="/js/clean-blog.min.js"></script>

  </body>
</html>

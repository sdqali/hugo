<!DOCTYPE html5>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us" prefix="og: http://ogp.me/ns#">
  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Integration testing Spring command line applications</title>

    
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    
    <link href="/css/clean-blog.min.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">

    
    <link href="/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='/css/fonts.css' rel='stylesheet' type='text/css'>

    
    
    

</head>

  
  
  
  
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@sdqali">
  <meta name="twitter:creator" content="@sdqali">
  <meta name="twitter:title" content="Integration testing Spring command line applications">
  <meta name="twitter:description" content="">
  <meta name="twitter:image" content="http://sdqali.in/images/spring-by-pivotal.png">

  <meta property="og:title" content="Integration testing Spring command line applications" />
  <meta property="og:description" content="" itemprop="description"/>
  <meta property="og:url" content="http://sdqali.in/blog/2015/12/11/integration-testing-spring-command-line-applications/" />
  <meta property="og:image" content="http://sdqali.in/images/spring-by-pivotal.png" />
  <body>

    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Sadique Ali</a>
    </div>

    
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/">Home</a> </li>
        <li><a href="/blog/">Blog</a> </li>
        <li><a href="/about">About</a> </li>
        <li><a href="/index.xml">Atom Feed</a> </li>
        <li><a href="https://github.com/sdqali">GitHub</a> </li>
        <li><a href="https://twitter.com/sdqali">Twitter</a> </li>
        <li><a href="https://www.linkedin.com/in/sdqali">LinkedIn</a> </li>
      </ul>
    </div>
    
  </div>
  
</nav>




    
    
    <header class="intro-header">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="site-heading">
              <h1> Integration testing Spring command line applications</h1>
              <span class="meta">Fri, Dec 11, 2015</span>
            </div>
          </div>
        </div>
      </div>
    </header>


    
    <article>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <p>In the <a href="/blog/2015/12/10/integration-testing-challenges-for-non-web-spring-applications/">last blog post</a>, I wrote about the challenges of writing an integration test for a Spring command line application. One of the solutions for this issue discussed in the blog post was to use the <code>@IntegrationTest</code> annotations to inject Java system properties and use that to run the application instead of the normal command line arguments. This blog post describes how to perform this.</p>

<p>The first step is to rewrite our test to use the <code>@IntegrationTest</code> annotations. This will result in a test that looks as follows:</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #9999FF">@RunWith</span><span style="color: #555555">(</span>SpringJUnit4ClassRunner<span style="color: #555555">.</span><span style="color: #330099">class</span><span style="color: #555555">)</span>
<span style="color: #9999FF">@SpringApplicationConfiguration</span><span style="color: #555555">(</span>classes <span style="color: #555555">=</span> <span style="color: #555555">{</span>Application<span style="color: #555555">.</span><span style="color: #330099">class</span><span style="color: #555555">})</span>
<span style="color: #9999FF">@IntegrationTest</span><span style="color: #555555">(</span>value <span style="color: #555555">=</span> <span style="color: #CC3300">&quot;input:expectedOutput&quot;</span><span style="color: #555555">)</span>
<span style="color: #006699; font-weight: bold">public</span> <span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">ApplicationIntegrationTest</span> <span style="color: #555555">{</span>
    <span style="color: #9999FF">@Autowired</span>
    <span style="color: #006699; font-weight: bold">private</span> Application application<span style="color: #555555">;</span>

    <span style="color: #9999FF">@Rule</span>
    <span style="color: #006699; font-weight: bold">public</span> OutputCapture outputCapture <span style="color: #555555">=</span> <span style="color: #006699; font-weight: bold">new</span> OutputCapture<span style="color: #555555">();</span>

    <span style="color: #9999FF">@Test</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">void</span> <span style="color: #CC00FF">shouldGenerateResultFiles</span><span style="color: #555555">()</span> <span style="color: #006699; font-weight: bold">throws</span> Exception <span style="color: #555555">{</span>
        application<span style="color: #555555">.</span><span style="color: #330099">run</span><span style="color: #555555">();</span>
        assertTrue<span style="color: #555555">(</span>outputCapture<span style="color: #555555">.</span><span style="color: #330099">toString</span><span style="color: #555555">().</span><span style="color: #330099">contains</span><span style="color: #555555">(</span><span style="color: #CC3300">&quot;expectedOutput&quot;</span><span style="color: #555555">));</span>
    <span style="color: #555555">}</span>
<span style="color: #555555">}</span>
</pre></div>

<p>At this point, it is worth taking a look at what the <code>@IntegrationTest</code> annotation causes Spring to do. This is a meta-annotation <sup class="footnote-ref" id="fnref:1"><a rel="footnote" href="#fn:1">1</a></sup> that specifies a number of test listeners including <code>IntegrationTestPropertiesListener</code>.</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #9999FF">@Documented</span>
<span style="color: #9999FF">@Inherited</span>
<span style="color: #9999FF">@Retention</span><span style="color: #555555">(</span>RetentionPolicy<span style="color: #555555">.</span><span style="color: #330099">RUNTIME</span><span style="color: #555555">)</span>
<span style="color: #9999FF">@Target</span><span style="color: #555555">(</span>ElementType<span style="color: #555555">.</span><span style="color: #330099">TYPE</span><span style="color: #555555">)</span>
<span style="color: #9999FF">@TestExecutionListeners</span><span style="color: #555555">(</span>listeners <span style="color: #555555">=</span> <span style="color: #555555">{</span> IntegrationTestPropertiesListener<span style="color: #555555">.</span><span style="color: #330099">class</span><span style="color: #555555">,</span>
        DirtiesContextBeforeModesTestExecutionListener<span style="color: #555555">.</span><span style="color: #330099">class</span><span style="color: #555555">,</span>
        DependencyInjectionTestExecutionListener<span style="color: #555555">.</span><span style="color: #330099">class</span><span style="color: #555555">,</span>
        DirtiesContextTestExecutionListener<span style="color: #555555">.</span><span style="color: #330099">class</span><span style="color: #555555">,</span>
        TransactionalTestExecutionListener<span style="color: #555555">.</span><span style="color: #330099">class</span><span style="color: #555555">,</span> SqlScriptsTestExecutionListener<span style="color: #555555">.</span><span style="color: #330099">class</span> <span style="color: #555555">})</span>
<span style="color: #006699; font-weight: bold">public</span> <span style="color: #9999FF">@interface</span> IntegrationTest <span style="color: #555555">{</span>
    String<span style="color: #555555">[]</span> <span style="color: #CC00FF">value</span><span style="color: #555555">()</span> <span style="color: #006699; font-weight: bold">default</span> <span style="color: #555555">{};</span>
<span style="color: #555555">}</span>
</pre></div>

<p><code>IntegrationTestPropertiesListener</code> is an implementation of <code>TestExecutionListener</code> which is a mechanism used by Spring to react to test execution events like <code>beforeTestClass</code>, <code>prepareTestInstance</code>, <code>beforeTestMethod</code>, <code>beforeTestMethod</code> and <code>afterTestClass</code>.</p>

<p>For the purposes of what we are trying to achieve, the listener we are really interested in is the <code>beforeTestClass</code> of <code>IntegrationTestPropertiesListener</code>.</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>    <span style="color: #9999FF">@Override</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">void</span> <span style="color: #CC00FF">prepareTestInstance</span><span style="color: #555555">(</span>TestContext testContext<span style="color: #555555">)</span> <span style="color: #006699; font-weight: bold">throws</span> Exception <span style="color: #555555">{</span>
        Class<span style="color: #555555">&lt;?&gt;</span> testClass <span style="color: #555555">=</span> testContext<span style="color: #555555">.</span><span style="color: #330099">getTestClass</span><span style="color: #555555">();</span>
        AnnotationAttributes annotationAttributes <span style="color: #555555">=</span> AnnotatedElementUtils
                <span style="color: #555555">.</span><span style="color: #330099">getMergedAnnotationAttributes</span><span style="color: #555555">(</span>testClass<span style="color: #555555">,</span>
                        IntegrationTest<span style="color: #555555">.</span><span style="color: #330099">class</span><span style="color: #555555">.</span><span style="color: #330099">getName</span><span style="color: #555555">());</span>
        <span style="color: #006699; font-weight: bold">if</span> <span style="color: #555555">(</span>annotationAttributes <span style="color: #555555">!=</span> <span style="color: #006699; font-weight: bold">null</span><span style="color: #555555">)</span> <span style="color: #555555">{</span>
            addPropertySourceProperties<span style="color: #555555">(</span>testContext<span style="color: #555555">,</span>
                    annotationAttributes<span style="color: #555555">.</span><span style="color: #330099">getStringArray</span><span style="color: #555555">(</span><span style="color: #CC3300">&quot;value&quot;</span><span style="color: #555555">));</span>
        <span style="color: #555555">}</span>
    <span style="color: #555555">}</span>
</pre></div>

<p>As we can see, the value of the <code>value</code> element <sup class="footnote-ref" id="fnref:2"><a rel="footnote" href="#fn:2">2</a></sup> of our <code>@IntegrationTest</code> gets injected to the configuration of the test context.</p>

<p>Now that we have understood and used the <code>@IntegrationTest</code> annotation to push in configuration, it is time to make our application consume this configuration.</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #9999FF">@Configuration</span>
<span style="color: #9999FF">@EnableAutoConfiguration</span>
<span style="color: #9999FF">@ComponentScan</span>
<span style="color: #006699; font-weight: bold">public</span> <span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">Application</span> <span style="color: #006699; font-weight: bold">implements</span> CommandLineRunner <span style="color: #555555">{</span>
    <span style="color: #9999FF">@Autowired</span>
    DataService dataService<span style="color: #555555">;</span>

    <span style="color: #9999FF">@Value</span><span style="color: #555555">(</span><span style="color: #CC3300">&quot;${input}&quot;</span><span style="color: #555555">)</span>
    String input<span style="color: #555555">;</span>

    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #006699; font-weight: bold">static</span> <span style="color: #007788; font-weight: bold">void</span> <span style="color: #CC00FF">main</span><span style="color: #555555">(</span>String<span style="color: #555555">[]</span> args<span style="color: #555555">)</span> <span style="color: #555555">{</span>
        SpringApplication<span style="color: #555555">.</span><span style="color: #330099">run</span><span style="color: #555555">(</span>Application<span style="color: #555555">.</span><span style="color: #330099">class</span><span style="color: #555555">,</span> args<span style="color: #555555">);</span>
    <span style="color: #555555">}</span>

    <span style="color: #9999FF">@Override</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">void</span> <span style="color: #CC00FF">run</span><span style="color: #555555">(</span>String<span style="color: #555555">...</span> args<span style="color: #555555">)</span> <span style="color: #555555">{</span>
        dataService<span style="color: #555555">.</span><span style="color: #330099">perform</span><span style="color: #555555">(</span>input<span style="color: #555555">);</span>
    <span style="color: #555555">}</span>
<span style="color: #555555">}</span>
</pre></div>

<p>An added benefit of this approach is that this forces us to use named parameter arguments when running the application as opposed to the position based command line arguments. This of course does not solve the problem of testing if you absolutely have to use position based arguments for your application. It would be nice Spring provided a mechanism to inject the command line arguments in a test before <code>SpringApplicationContextLoader</code> <sup class="footnote-ref" id="fnref:3"><a rel="footnote" href="#fn:3">3</a></sup> took over. But I suspect that this is not a common enough use case of Spring that users have asked the Spring team to implement it.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">Meta annotations are Spring annotations that can modify and act up on other annotations. For an example of customizing behavior using meta annotations, see <a href="/blog/2015/12/06/implementing-custom-annotations-for-spring-mvc/">this blog post</a>.
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
<li id="fn:2">The tendency of programmers to name the default element of an annotation <code>value</code> is one of my least favorite aspects of Java annotations. In most cases, there is another name that conveys the intent of the element better. I plan to write my thoughts about this in a blog post soon.
 <a class="footnote-return" href="#fnref:2"><sup>[return]</sup></a></li>
<li id="fn:3">See the previous blog post to see how <code>SpringApplicationContextLoader</code> executes the application without arguments.
 <a class="footnote-return" href="#fnref:3"><sup>[return]</sup></a></li>
</ol>
</div>

            <p class="comments">
  If you have questions or comments about this blog post, you can get in touch with me on Twitter <a href="https://twitter.com/sdqali">@sdqali</a>.
</p>

          </div>
        </div>
      </div>
    </article>

    <hr>

    
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          <li>
            <a href="https://twitter.com/sdqali">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="https://linkedin.com/in/sdqali">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="https://github.com/sdqali">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="/index.xml">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
        </ul>
        <p class="copyright text-muted">&copy; All rights reserved.</p>
      </div>
    </div>
  </div>
</footer>


<script src="/js/jquery.js"></script>


<script src="/js/bootstrap.min.js"></script>


<script src="/js/clean-blog.min.js"></script>

<script src="/js/keen.min.3.3.0.js" type="text/javascript"></script>
<script src="/js/parseuri.js" type="text/javascript"></script>
<script src="/js/ua-parser.min.js" type="text/javascript
"></script>
 <script src="/js/Math.uuid.js" type="text/javascript"></script>
<script src="/js/analytics.js" type="text/javascript"></script>


  </body>
</html>

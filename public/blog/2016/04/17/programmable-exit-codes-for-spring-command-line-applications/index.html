<!DOCTYPE html5>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us" prefix="og: http://ogp.me/ns#">
  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Programmable exit codes for Spring command line applications</title>

    
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    
    <link href="/css/clean-blog.min.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">

    
    <link href="/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='/css/fonts.css' rel='stylesheet' type='text/css'>

    
    
    

</head>

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@sdqali">
  <meta name="twitter:creator" content="@sdqali">
  <meta name="twitter:title" content="Programmable exit codes for Spring command line applications">
  <meta name="twitter:description" content="Spring&rsquo;s CommandLineRunner provides a great mechanism to build command line applications. While this convenience is great, applications that use CommandLineRunner require extra effort in some areas like integration testing. Exit codes are such an area - applications that use command line runners always report their exit code as 0 even if there are exceptions thrown. This blog post explains a way to get to programmable exit codes for such applications.
">
  <meta name="twitter:image" content="http://sdqali.in/images/spring-by-pivotal.png">

  <meta property="og:title" content="Programmable exit codes for Spring command line applications" />
  <meta property="og:description" content="Spring&rsquo;s CommandLineRunner provides a great mechanism to build command line applications. While this convenience is great, applications that use CommandLineRunner require extra effort in some areas like integration testing. Exit codes are such an area - applications that use command line runners always report their exit code as 0 even if there are exceptions thrown. This blog post explains a way to get to programmable exit codes for such applications.
" itemprop="description"/>
  <meta property="og:url" content="http://sdqali.in/blog/2016/04/17/programmable-exit-codes-for-spring-command-line-applications/" />
  <meta property="og:image" content="http://sdqali.in/images/spring-by-pivotal.png" />
  <body>

    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Sadique Ali</a>
    </div>

    
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/">Home</a> </li>
        <li><a href="/blog/">Blog</a> </li>
        <li><a href="/about">About</a> </li>
        <li><a href="/index.xml">Atom Feed</a> </li>
        <li><a href="https://github.com/sdqali">GitHub</a> </li>
        <li><a href="https://twitter.com/sdqali">Twitter</a> </li>
        <li><a href="https://www.linkedin.com/in/sdqali">LinkedIn</a> </li>
      </ul>
    </div>
    
  </div>
  
</nav>




    
    
    <header class="intro-header">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="site-heading">
              <h1> Programmable exit codes for Spring command line applications</h1>
              <span class="meta">Sun, Apr 17, 2016</span>
            </div>
          </div>
        </div>
      </div>
    </header>


    
    <article>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <p>Spring&rsquo;s <code>CommandLineRunner</code> provides a great mechanism to build command line applications. While this convenience is great, applications that use <code>CommandLineRunner</code> require extra effort in some areas like integration testing. Exit codes are such an area - applications that use command line runners always report their exit code as <code>0</code> even if there are exceptions thrown. This blog post explains a way to get to programmable exit codes for such applications.</p>

<p>The following example demonstrates this problem. Here we have a simple implementation of <code>CommandLineRunner</code> that simply throws a <code>RuntimeException</code> when started.</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #9999FF">@Component</span>
<span style="color: #9999FF">@Profile</span><span style="color: #555555">(</span><span style="color: #CC3300">&quot;exception&quot;</span><span style="color: #555555">)</span>
<span style="color: #006699; font-weight: bold">public</span> <span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">WillThrow</span> <span style="color: #006699; font-weight: bold">implements</span> CommandLineRunner <span style="color: #555555">{</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">void</span> <span style="color: #CC00FF">run</span><span style="color: #555555">(</span>String<span style="color: #555555">...</span> args<span style="color: #555555">)</span> <span style="color: #006699; font-weight: bold">throws</span> Exception <span style="color: #555555">{</span>
        <span style="color: #006699; font-weight: bold">throw</span> <span style="color: #006699; font-weight: bold">new</span> RuntimeException<span style="color: #555555">(</span><span style="color: #CC3300">&quot;This should kill the application&quot;</span><span style="color: #555555">);</span>
    <span style="color: #555555">}</span>
<span style="color: #555555">}</span>
</pre></div>

<p>When this application runs, we will see that the exit code is <code>0</code>, as expected.</p>

<pre><code>$ java -Dspring.profiles.active=exception -jar build/libs/exit-code-demo-1.0-SNAPSHOT.jar &gt;&gt; /dev/null 2&amp;&gt;1
$ echo $?
0
</code></pre>

<p>A simple way to propagate the right exit code is to use <code>java.lang.System#exit</code> and specify an error code. The following snippet shows this:</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #9999FF">@Component</span>
<span style="color: #9999FF">@Profile</span><span style="color: #555555">(</span><span style="color: #CC3300">&quot;exit&quot;</span><span style="color: #555555">)</span>
<span style="color: #006699; font-weight: bold">public</span> <span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">WillExit</span> <span style="color: #006699; font-weight: bold">implements</span> CommandLineRunner <span style="color: #555555">{</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">void</span> <span style="color: #CC00FF">run</span><span style="color: #555555">(</span>String<span style="color: #555555">...</span> args<span style="color: #555555">)</span> <span style="color: #006699; font-weight: bold">throws</span> Exception <span style="color: #555555">{</span>
        System<span style="color: #555555">.</span><span style="color: #330099">exit</span><span style="color: #555555">(</span><span style="color: #FF6600">3</span><span style="color: #555555">);</span>
    <span style="color: #555555">}</span>
<span style="color: #555555">}</span>
</pre></div>

<p>When run:</p>

<pre><code>$ java -Dspring.profiles.active=exit -jar build/libs/exit-code-demo-1.0-SNAPSHOT.jar &gt;&gt; /dev/null 2&amp;&gt;1
$ echo $?
3
</code></pre>

<p>This looks straightforward and easy. However, exiting the application from within the <code>CommandLineRunner</code> makes integration testing of this application difficult. Our tests will simply stop execution at that point without giving us the opportunity to assert anything.</p>

<p>At work, while looking for a solution to this, we stumbled across Spring&rsquo;s <code>ExitCodeGenerator</code> <sup class="footnote-ref" id="fnref:1"><a rel="footnote" href="#fn:1">1</a></sup>. It is an interface whose implementations Spring uses to look up what exit code to use. There are at least two ways to make use of <code>ExitCodeGenerator</code> - one involves making the application&rsquo;s Exceptions implement <code>ExitCodeGenerator</code> and the other involves making the command line runners themselves implement <code>ExitCodeGenerator</code>. We will look at the first approach here.</p>

<p>Our new command line runner will be as:</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #9999FF">@Component</span>
<span style="color: #9999FF">@Profile</span><span style="color: #555555">(</span><span style="color: #CC3300">&quot;exception&quot;</span><span style="color: #555555">)</span>
<span style="color: #006699; font-weight: bold">public</span> <span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">WillThrow</span> <span style="color: #006699; font-weight: bold">implements</span> CommandLineRunner<span style="color: #555555">{</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">void</span> <span style="color: #CC00FF">run</span><span style="color: #555555">(</span>String<span style="color: #555555">...</span> args<span style="color: #555555">)</span> <span style="color: #006699; font-weight: bold">throws</span> Exception <span style="color: #555555">{</span>
        <span style="color: #006699; font-weight: bold">throw</span> <span style="color: #006699; font-weight: bold">new</span> ExceptionWithExitCode<span style="color: #555555">(</span><span style="color: #CC3300">&quot;Hello&quot;</span><span style="color: #555555">);</span>
    <span style="color: #555555">}</span>
<span style="color: #555555">}</span>
</pre></div>

<p>And the exception will resemble:</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #006699; font-weight: bold">public</span> <span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">ExceptionWithExitCode</span> <span style="color: #006699; font-weight: bold">extends</span> RuntimeException <span style="color: #006699; font-weight: bold">implements</span> ExitCodeGenerator <span style="color: #555555">{</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #CC00FF">ExceptionWithExitCode</span><span style="color: #555555">(</span>String message<span style="color: #555555">)</span> <span style="color: #555555">{</span>
        <span style="color: #006699; font-weight: bold">super</span><span style="color: #555555">(</span>message<span style="color: #555555">);</span>
    <span style="color: #555555">}</span>

    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">int</span> <span style="color: #CC00FF">getExitCode</span><span style="color: #555555">()</span> <span style="color: #555555">{</span>
        <span style="color: #006699; font-weight: bold">return</span> <span style="color: #FF6600">13</span><span style="color: #555555">;</span>
    <span style="color: #555555">}</span>
<span style="color: #555555">}</span>
</pre></div>

<p>When the application runs:</p>

<pre><code>$ java -Dspring.profiles.active=exception -jar build/libs/exit-code-demo-1.0-SNAPSHOT.jar &gt;&gt; /dev/null 2&amp;&gt;1
$ echo $?
13
</code></pre>

<p>Obviously, this is a rather simple example, but you can see how <code>ExitCodeGenerator</code> allows us to have programmable exit codes. This allows us to have tests for our applications, while giving us the flexibility to control the exit code.</p>

<p>We will take a look at the second approach of using <code>ExitCodeGenerator</code> in another blog post.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1"><code>ExitCodeGenerator</code> is an &ldquo;Interface used to generate an &lsquo;exit code&rsquo; from a running command line SpringApplication.&rdquo;. You can find the JavaDocs <a href="http://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/ExitCodeGenerator.html">here</a>.
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
</ol>
</div>

          </div>
        </div>
      </div>
    </article>

    <hr>

    
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          <li>
            <a href="https://twitter.com/sdqali">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="https://linkedin.com/in/sdqali">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="https://github.com/sdqali">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="/index.xml">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
        </ul>
        <p class="copyright text-muted">&copy; All rights reserved.</p>
      </div>
    </div>
  </div>
</footer>


<script src="/js/jquery.js"></script>


<script src="/js/bootstrap.min.js"></script>


<script src="/js/clean-blog.min.js"></script>

  </body>
</html>

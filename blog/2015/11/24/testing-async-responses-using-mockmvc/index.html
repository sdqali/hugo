<!DOCTYPE html5>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us" prefix="og: http://ogp.me/ns#">
  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Testing async responses using MockMvc</title>

    
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    
    <link href="/css/clean-blog.min.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">

    
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    
    
    

</head>

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@sdqali">
  <meta name="twitter:creator" content="@sdqali">
  <meta name="twitter:title" content="Testing async responses using MockMvc">
  <meta name="twitter:description" content="There are times when a Spring MVC end point performs asynchronous operations. Testing these end points using MockMvc can be tricky because of the asynchronous nature in which the result of the operation is eventually returned. This blog post describes how to write tests in such scenarios.
">
  <meta name="twitter:image" content="http://sdqali.in/images/spring-by-pivotal.png">

  <meta property="og:title" content="Testing async responses using MockMvc" />
  <meta property="og:description" content="There are times when a Spring MVC end point performs asynchronous operations. Testing these end points using MockMvc can be tricky because of the asynchronous nature in which the result of the operation is eventually returned. This blog post describes how to write tests in such scenarios.
" itemprop="description"/>
  <meta property="og:url" content="http://sdqali.in/blog/2015/11/24/testing-async-responses-using-mockmvc/" />
  <meta property="og:image" content="http://sdqali.in/images/spring-by-pivotal.png" />
  <body>

    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Sadique Ali</a>
    </div>

    
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/">Home</a> </li>
        <li><a href="/blog/">Blog</a> </li>
        <li><a href="/about">About</a> </li>
        <li><a href="/index.xml">Atom Feed</a> </li>
        <li><a href="https://github.com/sdqali">GitHub</a> </li>
        <li><a href="https://twitter.com/sdqali">Twitter</a> </li>
        <li><a href="https://www.linkedin.com/in/sdqali">LinkedIn</a> </li>
      </ul>
    </div>
    
  </div>
  
</nav>




    
    
    <header class="intro-header">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="site-heading">
              <h1> Testing async responses using MockMvc</h1>
              <span class="meta">Tue, Nov 24, 2015</span>
            </div>
          </div>
        </div>
      </div>
    </header>


    
    <article>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <p>There are times when a Spring MVC end point performs asynchronous operations. Testing these end points using MockMvc can be tricky because of the asynchronous nature in which the result of the operation is eventually returned. This blog post describes how to write tests in such scenarios.</p>

<p>Let&rsquo;s take a look at the following example. In this example, we have a simple end point that responds with a JSON object when invoked.</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #9999FF">@RestController</span>
<span style="color: #9999FF">@RequestMapping</span><span style="color: #555555">(</span><span style="color: #CC3300">&quot;/test&quot;</span><span style="color: #555555">)</span>
<span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">ExampleController</span> <span style="color: #555555">{</span>
    <span style="color: #9999FF">@RequestMapping</span><span style="color: #555555">(</span>value <span style="color: #555555">=</span> <span style="color: #CC3300">&quot;/hello&quot;</span><span style="color: #555555">,</span>
            method <span style="color: #555555">=</span> GET<span style="color: #555555">,</span>
            consumes <span style="color: #555555">=</span> APPLICATION_JSON_VALUE<span style="color: #555555">,</span>
            produces <span style="color: #555555">=</span> APPLICATION_JSON_VALUE<span style="color: #555555">)</span>
    <span style="color: #9999FF">@ResponseStatus</span><span style="color: #555555">(</span>OK<span style="color: #555555">)</span>
    <span style="color: #006699; font-weight: bold">public</span> Map<span style="color: #555555">&lt;</span>String<span style="color: #555555">,</span> Object<span style="color: #555555">&gt;</span> <span style="color: #CC00FF">hello</span><span style="color: #555555">(){</span>
        <span style="color: #006699; font-weight: bold">return</span> helloMessage<span style="color: #555555">();</span>
    <span style="color: #555555">}</span>

    <span style="color: #006699; font-weight: bold">private</span> Map<span style="color: #555555">&lt;</span>String<span style="color: #555555">,</span> Object<span style="color: #555555">&gt;</span> <span style="color: #CC00FF">helloMessage</span><span style="color: #555555">()</span> <span style="color: #555555">{</span>
        <span style="color: #006699; font-weight: bold">return</span> Collections<span style="color: #555555">.</span><span style="color: #330099">singletonMap</span><span style="color: #555555">(</span><span style="color: #CC3300">&quot;message&quot;</span><span style="color: #555555">,</span> <span style="color: #CC3300">&quot;hello&quot;</span><span style="color: #555555">);</span>
    <span style="color: #555555">}</span>
<span style="color: #555555">}</span>
</pre></div>

<p>Writing a MockMvc test for this controller is fairly simple. The following test invokes the end point and asserts that the end point returns:</p>

<ul>
<li>The right HTTP response code <code>200</code></li>
<li>The right Content-Type <code>application/json</code></li>
<li>The right JSON message</li>
</ul>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #9999FF">@RunWith</span><span style="color: #555555">(</span>MockitoJUnitRunner<span style="color: #555555">.</span><span style="color: #330099">class</span><span style="color: #555555">)</span>
<span style="color: #006699; font-weight: bold">public</span> <span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">ExampleControllerTest</span> <span style="color: #555555">{</span>

    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #006699; font-weight: bold">static</span> <span style="color: #006699; font-weight: bold">final</span> String CONTENT_TYPE <span style="color: #555555">=</span> <span style="color: #CC3300">&quot;Content-Type&quot;</span><span style="color: #555555">;</span>
    <span style="color: #006699; font-weight: bold">private</span> ExampleController controller<span style="color: #555555">;</span>
    <span style="color: #006699; font-weight: bold">private</span> MockMvc mockMvc<span style="color: #555555">;</span>

    <span style="color: #9999FF">@Before</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">void</span> <span style="color: #CC00FF">setUp</span><span style="color: #555555">()</span> <span style="color: #555555">{</span>
        controller <span style="color: #555555">=</span> <span style="color: #006699; font-weight: bold">new</span> ExampleController<span style="color: #555555">();</span>
        mockMvc <span style="color: #555555">=</span> MockMvcBuilders
                <span style="color: #555555">.</span><span style="color: #330099">standaloneSetup</span><span style="color: #555555">(</span>controller<span style="color: #555555">)</span>
                <span style="color: #555555">.</span><span style="color: #330099">build</span><span style="color: #555555">();</span>
    <span style="color: #555555">}</span>

    <span style="color: #9999FF">@Test</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">void</span> <span style="color: #CC00FF">shouldHaveAMessageInResponse</span><span style="color: #555555">()</span> <span style="color: #006699; font-weight: bold">throws</span> Exception <span style="color: #555555">{</span>
        mockMvc
                <span style="color: #555555">.</span><span style="color: #330099">perform</span><span style="color: #555555">(</span>get<span style="color: #555555">(</span><span style="color: #CC3300">&quot;/test/hello&quot;</span><span style="color: #555555">)</span>
                        <span style="color: #555555">.</span><span style="color: #330099">contentType</span><span style="color: #555555">(</span>APPLICATION_JSON<span style="color: #555555">))</span>
                <span style="color: #555555">.</span><span style="color: #330099">andDo</span><span style="color: #555555">(</span>print<span style="color: #555555">())</span>
                <span style="color: #555555">.</span><span style="color: #330099">andExpect</span><span style="color: #555555">(</span>status<span style="color: #555555">().</span><span style="color: #330099">isOk</span><span style="color: #555555">())</span>
                <span style="color: #555555">.</span><span style="color: #330099">andExpect</span><span style="color: #555555">(</span>header<span style="color: #555555">().</span><span style="color: #330099">string</span><span style="color: #555555">(</span>CONTENT_TYPE<span style="color: #555555">,</span> APPLICATION_JSON_VALUE<span style="color: #555555">))</span>
                <span style="color: #555555">.</span><span style="color: #330099">andExpect</span><span style="color: #555555">(</span>jsonPath<span style="color: #555555">(</span><span style="color: #CC3300">&quot;message&quot;</span><span style="color: #555555">).</span><span style="color: #330099">value</span><span style="color: #555555">(</span><span style="color: #CC3300">&quot;hello&quot;</span><span style="color: #555555">));</span>
    <span style="color: #555555">}</span>
<span style="color: #555555">}</span>
</pre></div>

<p>Now, lets try and write a similar test for an end point uses <code>DeferredResult</code> to do asynchronous request processing. The end point in this example just wraps the JSON structure in <code>DeferredResult</code> and returns, whereas there will be a long running asynchronous process in a more useful case. But the idea remains the same.</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>    <span style="color: #9999FF">@RequestMapping</span><span style="color: #555555">(</span>value <span style="color: #555555">=</span> <span style="color: #CC3300">&quot;/deferred&quot;</span><span style="color: #555555">,</span>
            method <span style="color: #555555">=</span> GET<span style="color: #555555">,</span>
            consumes <span style="color: #555555">=</span> APPLICATION_JSON_VALUE<span style="color: #555555">,</span>
            produces <span style="color: #555555">=</span> APPLICATION_JSON_VALUE
    <span style="color: #555555">)</span>
    <span style="color: #9999FF">@ResponseStatus</span><span style="color: #555555">(</span>OK<span style="color: #555555">)</span>
    <span style="color: #006699; font-weight: bold">public</span> DeferredResult<span style="color: #555555">&lt;</span>Map<span style="color: #555555">&gt;</span> <span style="color: #CC00FF">deferred</span><span style="color: #555555">()</span> <span style="color: #555555">{</span>
        DeferredResult<span style="color: #555555">&lt;</span>Map<span style="color: #555555">&gt;</span> deferredResult <span style="color: #555555">=</span> <span style="color: #006699; font-weight: bold">new</span> DeferredResult<span style="color: #555555">&lt;&gt;();</span>
        deferredResult<span style="color: #555555">.</span><span style="color: #330099">setResult</span><span style="color: #555555">(</span>helloMessage<span style="color: #555555">());</span>
        <span style="color: #006699; font-weight: bold">return</span> deferredResult<span style="color: #555555">;</span>
    <span style="color: #555555">}</span>
</pre></div>

<p>If our test for this end point were to use the same mechanism as the previous test, we will start observing an interesting error.</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>    <span style="color: #9999FF">@Test</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">void</span> <span style="color: #CC00FF">shouldHaveAMessageInDeferredResponse</span><span style="color: #555555">()</span> <span style="color: #006699; font-weight: bold">throws</span> Exception <span style="color: #555555">{</span>
        mockMvc
                <span style="color: #555555">.</span><span style="color: #330099">perform</span><span style="color: #555555">(</span>get<span style="color: #555555">(</span><span style="color: #CC3300">&quot;/test/deferred&quot;</span><span style="color: #555555">)</span>
                        <span style="color: #555555">.</span><span style="color: #330099">contentType</span><span style="color: #555555">(</span>APPLICATION_JSON<span style="color: #555555">))</span>
                <span style="color: #555555">.</span><span style="color: #330099">andExpect</span><span style="color: #555555">(</span>status<span style="color: #555555">().</span><span style="color: #330099">isOk</span><span style="color: #555555">())</span>
                <span style="color: #555555">.</span><span style="color: #330099">andExpect</span><span style="color: #555555">(</span>header<span style="color: #555555">().</span><span style="color: #330099">string</span><span style="color: #555555">(</span>CONTENT_TYPE<span style="color: #555555">,</span> APPLICATION_JSON_VALUE<span style="color: #555555">))</span>
                <span style="color: #555555">.</span><span style="color: #330099">andExpect</span><span style="color: #555555">(</span>jsonPath<span style="color: #555555">(</span><span style="color: #CC3300">&quot;message&quot;</span><span style="color: #555555">).</span><span style="color: #330099">value</span><span style="color: #555555">(</span><span style="color: #CC3300">&quot;hello&quot;</span><span style="color: #555555">));</span>
    <span style="color: #555555">}</span>
</pre></div>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>Response header Content-Type expected:&lt;application/json&gt; but was:&lt;null&gt;
</pre></div>

<p>This happened because MockMvc did not wait for the asynchronous process to finish. The solution to this involves using MockMvc&rsquo;s <code>asyncDispatch</code>. AsyncDispatch creates a new request that continues from the result of a previous MockMvc request that started the asynchronous process.
The test re-written using <code>asyncDispatch</code> would be as follows:</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>    <span style="color: #9999FF">@Test</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">void</span> <span style="color: #CC00FF">shouldHaveAMessageInDeferredResponseWithAsyncDispatch</span><span style="color: #555555">()</span> <span style="color: #006699; font-weight: bold">throws</span> Exception <span style="color: #555555">{</span>
        MvcResult result <span style="color: #555555">=</span> mockMvc
                <span style="color: #555555">.</span><span style="color: #330099">perform</span><span style="color: #555555">(</span>get<span style="color: #555555">(</span><span style="color: #CC3300">&quot;/test/deferred&quot;</span><span style="color: #555555">)</span>
                        <span style="color: #555555">.</span><span style="color: #330099">contentType</span><span style="color: #555555">(</span>APPLICATION_JSON<span style="color: #555555">))</span>
                <span style="color: #555555">.</span><span style="color: #330099">andReturn</span><span style="color: #555555">();</span>

        mockMvc
                <span style="color: #555555">.</span><span style="color: #330099">perform</span><span style="color: #555555">(</span>asyncDispatch<span style="color: #555555">(</span>result<span style="color: #555555">))</span>
                <span style="color: #555555">.</span><span style="color: #330099">andExpect</span><span style="color: #555555">(</span>status<span style="color: #555555">().</span><span style="color: #330099">isOk</span><span style="color: #555555">())</span>
                <span style="color: #555555">.</span><span style="color: #330099">andExpect</span><span style="color: #555555">(</span>header<span style="color: #555555">().</span><span style="color: #330099">string</span><span style="color: #555555">(</span>CONTENT_TYPE<span style="color: #555555">,</span> APPLICATION_JSON_VALUE<span style="color: #555555">))</span>
                <span style="color: #555555">.</span><span style="color: #330099">andExpect</span><span style="color: #555555">(</span>jsonPath<span style="color: #555555">(</span><span style="color: #CC3300">&quot;message&quot;</span><span style="color: #555555">).</span><span style="color: #330099">value</span><span style="color: #555555">(</span><span style="color: #CC3300">&quot;hello&quot;</span><span style="color: #555555">));</span>
    <span style="color: #555555">}</span>
</pre></div>

<p>The same approach can be employed to test when controllers use Java 8&rsquo;s <code>CompletableFuture</code>.</p>

          </div>
        </div>
      </div>
    </article>

    <hr>

    
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          <li>
            <a href="https://twitter.com/sdqali">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="https://linkedin.com/in/sdqali">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="https://github.com/sdqali">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="/index.xml">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
        </ul>
        <p class="copyright text-muted">&copy; All rights reserved.</p>
      </div>
    </div>
  </div>
</footer>


<script src="/js/jquery.js"></script>


<script src="/js/bootstrap.min.js"></script>


<script src="/js/clean-blog.min.js"></script>

  </body>
</html>

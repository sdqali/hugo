<!DOCTYPE html5>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us" prefix="og: http://ogp.me/ns#">
  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Integration testing challenges for non-web Spring applications</title>

    
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    
    <link href="/css/clean-blog.min.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">

    
    <link href="/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='/css/fonts.css' rel='stylesheet' type='text/css'>

    
    
    

</head>

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@sdqali">
  <meta name="twitter:creator" content="@sdqali">
  <meta name="twitter:title" content="Integration testing challenges for non-web Spring applications">
  <meta name="twitter:description" content="We are building a command line data loader application at work that uses Spring. One of the things that I took us more time that it should have to figure out was how to write an integration test that invokes the command line application with the right command line arguments. This blog post describes this scenario and a potential solution to this problem.
">
  <meta name="twitter:image" content="http://sdqali.in/images/spring-by-pivotal.png">

  <meta property="og:title" content="Integration testing challenges for non-web Spring applications" />
  <meta property="og:description" content="We are building a command line data loader application at work that uses Spring. One of the things that I took us more time that it should have to figure out was how to write an integration test that invokes the command line application with the right command line arguments. This blog post describes this scenario and a potential solution to this problem.
" itemprop="description"/>
  <meta property="og:url" content="http://sdqali.in/blog/2015/12/10/integration-testing-challenges-for-non-web-spring-applications/" />
  <meta property="og:image" content="http://sdqali.in/images/spring-by-pivotal.png" />
  <body>

    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Sadique Ali</a>
    </div>

    
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/">Home</a> </li>
        <li><a href="/blog/">Blog</a> </li>
        <li><a href="/about">About</a> </li>
        <li><a href="/index.xml">Atom Feed</a> </li>
        <li><a href="https://github.com/sdqali">GitHub</a> </li>
        <li><a href="https://twitter.com/sdqali">Twitter</a> </li>
        <li><a href="https://www.linkedin.com/in/sdqali">LinkedIn</a> </li>
      </ul>
    </div>
    
  </div>
  
</nav>




    
    
    <header class="intro-header">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="site-heading">
              <h1> Integration testing challenges for non-web Spring applications</h1>
              <span class="meta">Thu, Dec 10, 2015</span>
            </div>
          </div>
        </div>
      </div>
    </header>


    
    <article>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <p>We are building a command line data loader application at work that uses Spring. One of the things that I took us more time that it should have to figure out was how to write an integration test that invokes the command line application with the right command line arguments. This blog post describes this scenario and a potential solution to this problem.
</p>

<p>Let&rsquo;s consider a simple command line application implemented using Spring Boot&rsquo;s <code>CommandLineRunner</code>. The main application class is fairly simple.</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #9999FF">@Configuration</span>
<span style="color: #9999FF">@EnableAutoConfiguration</span>
<span style="color: #9999FF">@ComponentScan</span>
<span style="color: #006699; font-weight: bold">public</span> <span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">Application</span> <span style="color: #006699; font-weight: bold">implements</span> CommandLineRunner <span style="color: #555555">{</span>
    <span style="color: #9999FF">@Autowired</span>
    DataService dataService<span style="color: #555555">;</span>

    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #006699; font-weight: bold">static</span> <span style="color: #007788; font-weight: bold">void</span> <span style="color: #CC00FF">main</span><span style="color: #555555">(</span>String<span style="color: #555555">[]</span> args<span style="color: #555555">)</span> <span style="color: #555555">{</span>
        SpringApplication<span style="color: #555555">.</span><span style="color: #330099">run</span><span style="color: #555555">(</span>Application<span style="color: #555555">.</span><span style="color: #330099">class</span><span style="color: #555555">,</span> args<span style="color: #555555">);</span>
    <span style="color: #555555">}</span>

    <span style="color: #9999FF">@Override</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">void</span> <span style="color: #CC00FF">run</span><span style="color: #555555">(</span>String<span style="color: #555555">...</span> args<span style="color: #555555">)</span> <span style="color: #555555">{</span>
        dataService<span style="color: #555555">.</span><span style="color: #330099">perform</span><span style="color: #555555">(</span>args<span style="color: #555555">[</span><span style="color: #FF6600">0</span><span style="color: #555555">]);</span>
    <span style="color: #555555">}</span>
<span style="color: #555555">}</span>
</pre></div>

<p>In addition to this, there is a configuration class <code>AppConfiguration</code>.</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #9999FF">@Configuration</span>
<span style="color: #006699; font-weight: bold">public</span> <span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">AppConfiguration</span> <span style="color: #555555">{</span>
    <span style="color: #9999FF">@Bean</span>
    <span style="color: #006699; font-weight: bold">public</span> DataService <span style="color: #CC00FF">dataService</span><span style="color: #555555">()</span> <span style="color: #555555">{</span>
        <span style="color: #006699; font-weight: bold">return</span> <span style="color: #006699; font-weight: bold">new</span> DataService<span style="color: #555555">();</span>
    <span style="color: #555555">}</span>
<span style="color: #555555">}</span>
</pre></div>

<p>The <code>DataService</code> simply prints the argument it receives.</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #006699; font-weight: bold">public</span> <span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">DataService</span> <span style="color: #555555">{</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">void</span> <span style="color: #CC00FF">perform</span><span style="color: #555555">(</span>String arg<span style="color: #555555">)</span> <span style="color: #555555">{</span>
        System<span style="color: #555555">.</span><span style="color: #330099">out</span><span style="color: #555555">.</span><span style="color: #330099">println</span><span style="color: #555555">(</span>arg<span style="color: #555555">);</span>
    <span style="color: #555555">}</span>
<span style="color: #555555">}</span>
</pre></div>

<p>If we were to attempt writing an integration test for this application, it would look like this:</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #9999FF">@RunWith</span><span style="color: #555555">(</span>SpringJUnit4ClassRunner<span style="color: #555555">.</span><span style="color: #330099">class</span><span style="color: #555555">)</span>
<span style="color: #9999FF">@SpringApplicationConfiguration</span><span style="color: #555555">(</span>classes <span style="color: #555555">=</span> <span style="color: #555555">{</span>Application<span style="color: #555555">.</span><span style="color: #330099">class</span><span style="color: #555555">})</span>
<span style="color: #006699; font-weight: bold">public</span> <span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">ApplicationIntegrationTest</span> <span style="color: #555555">{</span>
    <span style="color: #9999FF">@Autowired</span>
    <span style="color: #006699; font-weight: bold">private</span> Application application<span style="color: #555555">;</span>


    <span style="color: #9999FF">@Rule</span>
    <span style="color: #006699; font-weight: bold">public</span> OutputCapture outputCapture <span style="color: #555555">=</span> <span style="color: #006699; font-weight: bold">new</span> OutputCapture<span style="color: #555555">();</span>

    <span style="color: #9999FF">@Test</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">void</span> <span style="color: #CC00FF">shouldGenerateResultFiles</span><span style="color: #555555">()</span> <span style="color: #006699; font-weight: bold">throws</span> Exception <span style="color: #555555">{</span>
        application<span style="color: #555555">.</span><span style="color: #330099">run</span><span style="color: #555555">(</span><span style="color: #CC3300">&quot;sampleOutPut&quot;</span><span style="color: #555555">);</span>
        assertTrue<span style="color: #555555">(</span>outputCapture<span style="color: #555555">.</span><span style="color: #330099">toString</span><span style="color: #555555">().</span><span style="color: #330099">contains</span><span style="color: #555555">(</span><span style="color: #CC3300">&quot;sampleOutput&quot;</span><span style="color: #555555">));</span>
    <span style="color: #555555">}</span>
<span style="color: #555555">}</span>
</pre></div>

<p>That test is straightforward—it loads the Spring context with all the beans, runs the application with parameters and expects the parameter to be printed to the console.</p>

<p>Except, it does not work. If we were to execute the above test, we will get the following error:</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>...
Caused by: java.lang.ArrayIndexOutOfBoundsException: 0
at in.sdqali.springapps.Application.run<span style="color: #555555">(</span>Application.java:24<span style="color: #555555">)</span> ~<span style="color: #555555">[</span>main/:na<span style="color: #555555">]</span>
...
</pre></div>

<p>What happened? It looks like the <code>run</code> method was called with out any arguments while the test configuration was loaded.</p>

<p>Let‘s try and understand wh
y this happens. Remember how we annotated the test with <code>@SpringApplicationConfiguration</code>? This annotation is a meta-annotation <sup class="footnote-ref" id="fnref:1"><a rel="footnote" href="#fn:1">1</a></sup> specified as:</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #9999FF">@ContextConfiguration</span><span style="color: #555555">(</span>loader <span style="color: #555555">=</span> SpringApplicationContextLoader<span style="color: #555555">.</span><span style="color: #330099">class</span><span style="color: #555555">)</span>
<span style="color: #9999FF">@Documented</span>
<span style="color: #9999FF">@Inherited</span>
<span style="color: #9999FF">@Retention</span><span style="color: #555555">(</span>RetentionPolicy<span style="color: #555555">.</span><span style="color: #330099">RUNTIME</span><span style="color: #555555">)</span>
<span style="color: #9999FF">@Target</span><span style="color: #555555">(</span>ElementType<span style="color: #555555">.</span><span style="color: #330099">TYPE</span><span style="color: #555555">)</span>
<span style="color: #006699; font-weight: bold">public</span> <span style="color: #9999FF">@interface</span> SpringApplicationConfiguration <span style="color: #555555">{</span>
<span style="color: #555555">...</span>
<span style="color: #555555">}</span>
</pre></div>

<p><code>ContextConfiguration</code> is an annotation that allows tests to specify the information used to load and configure the application context. From the Java doc for this annotation:</p>

<pre><code> * {@code @ContextConfiguration} defines class-level metadata that is used to determine
 * how to load and configure an {@link org.springframework.context.ApplicationContext
 * ApplicationContext} for integration tests.
</code></pre>

<p>This brings us to <code>SpringApplicationContextLoader</code>‘s <code>loadContext</code> method and buried deep inside are these line:</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>application<span style="color: #555555">.</span><span style="color: #330099">setInitializers</span><span style="color: #555555">(</span>initializers<span style="color: #555555">);</span>
ConfigurableApplicationContext applicationContext <span style="color: #555555">=</span> application<span style="color: #555555">.</span><span style="color: #330099">run</span><span style="color: #555555">();</span>
<span style="color: #006699; font-weight: bold">return</span> applicationContext<span style="color: #555555">;</span>
</pre></div>

<p>So, regardless of how many arguments our command line application was supposed to take, this loader always call the application without any arguments.</p>

<p>There are two solutions I have been able to think of for this problem:</p>

<ul>
<li>Override the<code>SpringApplicationContextLoader</code> and pass the necessary arguments in <code>application.run()</code>. This is definitely not an elegant or easy solution.</li>
<li>Use an environment variable instead of the command line argument as the input to the service. This will allow us to inject this variable using the <code>@IntegrationTest</code> annotation.</li>
</ul>

<p>My next blog post will discuss the second approach.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">Meta annotations. <a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/beans.html#beans-meta-annotations">Spring documentation</a>. To see how to use meta-annotations to write custom annoations, see <a href="/blog/2015/12/06/implementing-custom-annotations-for-spring-mvc/">this blog post</a>.
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
</ol>
</div>
            <p class="comments">
  If you have questions or comments about this blog post, you can get in touch with me on Twitter <a href="https://twitter.com/sdqali">@sdqali</a>.
</p>

          </div>
        </div>
      </div>
    </article>

    <hr>

    
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          <li>
            <a href="https://twitter.com/sdqali">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="https://linkedin.com/in/sdqali">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="https://github.com/sdqali">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="/index.xml">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
        </ul>
        <p class="copyright text-muted">&copy; All rights reserved.</p>
      </div>
    </div>
  </div>
</footer>


<script src="/js/jquery.js"></script>


<script src="/js/bootstrap.min.js"></script>


<script src="/js/clean-blog.min.js"></script>

<script src="/js/keen.min.3.3.0.js" type="text/javascript"></script>
<script src="/js/parseuri.js" type="text/javascript"></script>
<script src="/js/ua-parser.min.js" type="text/javascript
"></script>
 <script src="/js/Math.uuid.js" type="text/javascript"></script>
<script src="/js/analytics.js" type="text/javascript"></script>


  </body>
</html>

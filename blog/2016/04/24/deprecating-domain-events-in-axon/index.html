<!DOCTYPE html5>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us" prefix="og: http://ogp.me/ns#">
  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Deprecating domain events in Axon</title>

    
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    
    <link href="/css/clean-blog.min.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">

    
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    
    
    

</head>

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@sdqali">
  <meta name="twitter:creator" content="@sdqali">
  <meta name="twitter:title" content="Deprecating domain events in Axon">
  <meta name="twitter:description" content="Recently at work, we had to deprecate a domain event. This event used to represent an error scenario. However, the business had since decided that this is no longer a valid error scenario. Removing the Java class is not straight forward - since there are events of this type stored in the event store, every time the aggregate associated with this event is loaded, Axon will throw errors trying to de-serialize them.
">
  <meta name="twitter:image" content="http://sdqali.in/images/axon.png">

  <meta property="og:title" content="Deprecating domain events in Axon" />
  <meta property="og:description" content="Recently at work, we had to deprecate a domain event. This event used to represent an error scenario. However, the business had since decided that this is no longer a valid error scenario. Removing the Java class is not straight forward - since there are events of this type stored in the event store, every time the aggregate associated with this event is loaded, Axon will throw errors trying to de-serialize them.
" itemprop="description"/>
  <meta property="og:url" content="http://sdqali.in/blog/2016/04/24/deprecating-domain-events-in-axon/" />
  <meta property="og:image" content="http://sdqali.in/images/axon.png" />
  <body>

    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Sadique Ali</a>
    </div>

    
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/">Home</a> </li>
        <li><a href="/blog/">Blog</a> </li>
        <li><a href="/about">About</a> </li>
        <li><a href="/index.xml">Atom Feed</a> </li>
        <li><a href="https://github.com/sdqali">GitHub</a> </li>
        <li><a href="https://twitter.com/sdqali">Twitter</a> </li>
        <li><a href="https://www.linkedin.com/in/sdqali">LinkedIn</a> </li>
      </ul>
    </div>
    
  </div>
  
</nav>




    
    
    <header class="intro-header">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="site-heading">
              <h1> Deprecating domain events in Axon</h1>
              <span class="meta">Sun, Apr 24, 2016</span>
            </div>
          </div>
        </div>
      </div>
    </header>


    
    <article>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            

<p>Recently at work, we had to deprecate a domain event. This event used to represent an error scenario. However, the business had since decided that this is no longer a valid error scenario. Removing the Java class is not straight forward - since there are events of this type stored in the event store, every time the aggregate associated with this event is loaded, Axon will throw errors trying to de-serialize them.</p>

<p>Obviously, we need an Upcaster <sup class="footnote-ref" id="fnref:1"><a rel="footnote" href="#fn:1">1</a></sup> to take care of this situation. The Upcaster in this scenario will have to upcast this event to something representing the non-existence of this event, regardless of the revision. There are two ways to address this issue - Upcasting to an explicit NoOpEvent and upcasting to an empty list.</p>

<h2 id="upcasting-to-a-noopevent">Upcasting to a NoOpEvent</h2>

<p>Given an event <code>ValidationForFirstNameFailedEvent</code>, an upcaster that upcasts to a <code>NoOpEvent</code> can be implemented as follows:</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #006699; font-weight: bold">public</span> <span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">DeprecateValidationForFirstNameFailedEventUpcaster</span> <span style="color: #006699; font-weight: bold">extends</span> AbstractSingleEntryUpcaster <span style="color: #555555">{</span>
    <span style="color: #9999FF">@Override</span>
    <span style="color: #006699; font-weight: bold">protected</span> Object <span style="color: #CC00FF">doUpcast</span><span style="color: #555555">(</span>SerializedObject intermediateRepresentation<span style="color: #555555">,</span> UpcastingContext context<span style="color: #555555">)</span> <span style="color: #555555">{</span>
        <span style="color: #006699; font-weight: bold">return</span> <span style="color: #006699; font-weight: bold">new</span> SimpleSerializedType<span style="color: #555555">(</span>NoOpEvent<span style="color: #555555">.</span><span style="color: #330099">class</span><span style="color: #555555">.</span><span style="color: #330099">getName</span><span style="color: #555555">(),</span> <span style="color: #CC3300">&quot;1&quot;</span><span style="color: #555555">);</span>
    <span style="color: #555555">}</span>

    <span style="color: #9999FF">@Override</span>
    <span style="color: #006699; font-weight: bold">protected</span> SerializedType <span style="color: #CC00FF">doUpcast</span><span style="color: #555555">(</span>SerializedType serializedType<span style="color: #555555">)</span> <span style="color: #555555">{</span>
        <span style="color: #006699; font-weight: bold">return</span> <span style="color: #006699; font-weight: bold">new</span> SimpleSerializedType<span style="color: #555555">(</span>NoOpEvent<span style="color: #555555">.</span><span style="color: #330099">class</span><span style="color: #555555">.</span><span style="color: #330099">getName</span><span style="color: #555555">(),</span> <span style="color: #CC3300">&quot;1&quot;</span><span style="color: #555555">);</span>
    <span style="color: #555555">}</span>

    <span style="color: #9999FF">@Override</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">boolean</span> <span style="color: #CC00FF">canUpcast</span><span style="color: #555555">(</span>SerializedType serializedType<span style="color: #555555">)</span> <span style="color: #555555">{</span>
        <span style="color: #006699; font-weight: bold">return</span> serializedType<span style="color: #555555">.</span><span style="color: #330099">getName</span><span style="color: #555555">().</span><span style="color: #330099">equals</span><span style="color: #555555">(</span>ValidationForFirstNameFailedEvent<span style="color: #555555">.</span><span style="color: #330099">class</span><span style="color: #555555">.</span><span style="color: #330099">getName</span><span style="color: #555555">());</span>
    <span style="color: #555555">}</span>

    <span style="color: #9999FF">@Override</span>
    <span style="color: #006699; font-weight: bold">public</span> Class <span style="color: #CC00FF">expectedRepresentationType</span><span style="color: #555555">()</span> <span style="color: #555555">{</span>
        <span style="color: #006699; font-weight: bold">return</span> JsonNode<span style="color: #555555">.</span><span style="color: #330099">class</span><span style="color: #555555">;</span>
    <span style="color: #555555">}</span>
<span style="color: #555555">}</span>
</pre></div>

<p>As expected, this upcaster does not look at the revision of the intermediate representation and simply looks at the type of the event. And it completely discards any fields in the event and returns a simple type of the <code>NoOpEvent</code> class. Note that in this case, we are serializing the event as JSON using Jackson, hence the expected representation type is <code>com.fasterxml.jackson.databind.JsonNode</code>. If we were to use Axon&rsquo;s default XML serialization, the expected representation type will be <code>org.dom4j.Document</code></p>

<h3 id="upcasting-to-an-empty-list">Upcasting to an empty list</h3>

<p>Upcasting to an empty list can be easily achieved by implementing <code>Upcaster&lt;T&gt;</code> instead of extending <code>AbstractSingleEntryUpcaster</code>.</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #006699; font-weight: bold">public</span> <span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">ValidationForFirstNameFailedEventToEmptyListUpcaster</span> <span style="color: #006699; font-weight: bold">implements</span> Upcaster<span style="color: #555555">&lt;</span>JsonNode<span style="color: #555555">&gt;</span> <span style="color: #555555">{</span>
    <span style="color: #9999FF">@Override</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">boolean</span> <span style="color: #CC00FF">canUpcast</span><span style="color: #555555">(</span>SerializedType serializedType<span style="color: #555555">)</span> <span style="color: #555555">{</span>
        <span style="color: #006699; font-weight: bold">return</span> serializedType<span style="color: #555555">.</span><span style="color: #330099">getName</span><span style="color: #555555">().</span><span style="color: #330099">equals</span><span style="color: #555555">(</span>ValidationForFirstNameFailedEvent<span style="color: #555555">.</span><span style="color: #330099">class</span><span style="color: #555555">.</span><span style="color: #330099">getName</span><span style="color: #555555">());</span>
    <span style="color: #555555">}</span>

    <span style="color: #9999FF">@Override</span>
    <span style="color: #006699; font-weight: bold">public</span> Class<span style="color: #555555">&lt;</span>JsonNode<span style="color: #555555">&gt;</span> <span style="color: #CC00FF">expectedRepresentationType</span><span style="color: #555555">()</span> <span style="color: #555555">{</span>
        <span style="color: #006699; font-weight: bold">return</span> JsonNode<span style="color: #555555">.</span><span style="color: #330099">class</span><span style="color: #555555">;</span>
    <span style="color: #555555">}</span>

    <span style="color: #9999FF">@Override</span>
    <span style="color: #006699; font-weight: bold">public</span> List<span style="color: #555555">&lt;</span>SerializedObject<span style="color: #555555">&lt;?&gt;&gt;</span> upcast<span style="color: #555555">(</span>SerializedObject<span style="color: #555555">&lt;</span>JsonNode<span style="color: #555555">&gt;</span> intermediateRepresentation<span style="color: #555555">,</span>
        List<span style="color: #555555">&lt;</span>SerializedType<span style="color: #555555">&gt;</span> expectedTypes<span style="color: #555555">,</span> UpcastingContext context<span style="color: #555555">)</span> <span style="color: #555555">{</span>
        <span style="color: #006699; font-weight: bold">return</span> Collections<span style="color: #555555">.</span><span style="color: #330099">emptyList</span><span style="color: #555555">();</span>
    <span style="color: #555555">}</span>

    <span style="color: #9999FF">@Override</span>
    <span style="color: #006699; font-weight: bold">public</span> List<span style="color: #555555">&lt;</span>SerializedType<span style="color: #555555">&gt;</span> <span style="color: #CC00FF">upcast</span><span style="color: #555555">(</span>SerializedType serializedType<span style="color: #555555">)</span> <span style="color: #555555">{</span>
        <span style="color: #006699; font-weight: bold">return</span> Collections<span style="color: #555555">.</span><span style="color: #330099">emptyList</span><span style="color: #555555">();</span>
    <span style="color: #555555">}</span>
<span style="color: #555555">}</span>
</pre></div>

<p>This can also be done through extending <code>AbstractSingleEntryUpcaster</code> and returning <code>null</code> from both <code>upcast</code> methods. The class in turns returns empty lists for us. This is evident if we look at the JavaDoc for the methods</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>    <span style="color: #0099FF; font-style: italic">/**</span>
<span style="color: #0099FF; font-style: italic">     * Upcasts the given &lt;code&gt;intermediateRepresentation&lt;/code&gt; into zero or more other representations. The returned</span>
<span style="color: #0099FF; font-style: italic">     * list of Serialized Objects must match the given list of serialized types.</span>
<span style="color: #0099FF; font-style: italic">     * &lt;p/&gt;</span>
<span style="color: #0099FF; font-style: italic">     * This method may return &lt;code&gt;null&lt;/code&gt; to indicate a deprecated object.</span>
<span style="color: #0099FF; font-style: italic">     *</span>
<span style="color: #0099FF; font-style: italic">     * @param intermediateRepresentation The representation of the object to upcast</span>
<span style="color: #0099FF; font-style: italic">     * @param context                    An instance describing the context of the object to upcast</span>
<span style="color: #0099FF; font-style: italic">     * @return the new representation of the object</span>
<span style="color: #0099FF; font-style: italic">     */</span>
    <span style="color: #006699; font-weight: bold">protected</span> <span style="color: #006699; font-weight: bold">abstract</span> T <span style="color: #CC00FF">doUpcast</span><span style="color: #555555">(</span>SerializedObject<span style="color: #555555">&lt;</span>T<span style="color: #555555">&gt;</span> intermediateRepresentation<span style="color: #555555">,</span>
                                  UpcastingContext context<span style="color: #555555">);</span>
</pre></div>

<p>I posted this question in the <a href="https://groups.google.com/forum/#!topic/axonframework/G2tlU06mRPM">Axon mailing list</a> as well as our internal developer mailing list and upcasting to an empty list was the more popular choice. Allard Buijze, the creator of Axon had this to say:</p>

<blockquote>
<p>by upcasting to an empty list, you&rsquo;re explicitly indicating that the event no longer exists. When upcasting to a NoOpEvent, you implicitly mean the same thing, as no one is interested in a NoOp event.
So you achieve the same thing, but explicit always beats implicit in DDD ;-)</p>
</blockquote>

<p>While I agree with Allard that being explicit is better than being implicit (and not just in the context of DDD), I am not convinced that upcasting to an empty list is more explicit than upcasting to an explicit type. However, we went ahead with the empty list approach as it was the consensus among my coworkers.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">Upcasting is a technique of migrating the schema of events in an event-sourced system to keep up with changes in the business requirements. The Axon documentation has a <a href="http://www.axonframework.org/docs/2.0/repositories-and-event-stores.html#event-upcasting">very good primer</a> on upcasting, specifically in the context of Axon.
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
</ol>
</div>

          </div>
        </div>
      </div>
    </article>

    <hr>

    
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          <li>
            <a href="https://twitter.com/sdqali">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="https://linkedin.com/in/sdqali">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="https://github.com/sdqali">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="/index.xml">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
        </ul>
        <p class="copyright text-muted">&copy; All rights reserved.</p>
      </div>
    </div>
  </div>
</footer>


<script src="/js/jquery.js"></script>


<script src="/js/bootstrap.min.js"></script>


<script src="/js/clean-blog.min.js"></script>

  </body>
</html>

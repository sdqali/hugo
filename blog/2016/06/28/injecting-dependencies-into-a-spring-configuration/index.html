<!DOCTYPE html5>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us" prefix="og: http://ogp.me/ns#">
  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A blog about the Code I write and the Technologies I use. And other things that interest me.">
    <meta name="author" content="">

    
    
      
    
    

    <title>Injecting dependencies into a Spring @Configuration - Sadique Ali</title>

    
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    
    <link href="/css/clean-blog.min.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">

    
    <link href="/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='/css/fonts.css' rel='stylesheet' type='text/css'>

    
    
    

</head>

  <meta name="description" content="This is one of those blog posts about things I wish I had known before I spent a lot of time figuring out when something was not working as expected. Recently, we have been trying to extend a WebMvcConfigurerAdapter to wire up an HTTP request interceptor. And things did not work as we expected it to and we learned that our understanding of how Spring behaved under this situation was wrong. This is a write up to refer back to if and when we encounter this issue again.

" />
  <meta content="" name="keywords">

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@sdqali">
  <meta name="twitter:creator" content="@sdqali">
  <meta name="twitter:title" content="Injecting dependencies into a Spring @Configuration">
  <meta name="twitter:description" content="This is one of those blog posts about things I wish I had known before I spent a lot of time figuring out when something was not working as expected. Recently, we have been trying to extend a WebMvcConfigurerAdapter to wire up an HTTP request interceptor. And things did not work as we expected it to and we learned that our understanding of how Spring behaved under this situation was wrong. This is a write up to refer back to if and when we encounter this issue again.

">
  <meta name="twitter:image" content="http://sdqali.in/images/spring-by-pivotal.png">

  <meta property="og:title" content="Injecting dependencies into a Spring @Configuration" />
  <meta property="og:description" content="This is one of those blog posts about things I wish I had known before I spent a lot of time figuring out when something was not working as expected. Recently, we have been trying to extend a WebMvcConfigurerAdapter to wire up an HTTP request interceptor. And things did not work as we expected it to and we learned that our understanding of how Spring behaved under this situation was wrong. This is a write up to refer back to if and when we encounter this issue again.

" itemprop="description"/>
  <meta property="og:url" content="http://sdqali.in/blog/2016/06/28/injecting-dependencies-into-a-spring-configuration/" />
  <meta property="og:image" content="http://sdqali.in/images/spring-by-pivotal.png" />
  <body>

    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Sadique Ali</a>
    </div>

    
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/">Home</a> </li>
        <li><a href="/blog/">Blog</a> </li>
        <li><a href="/about">About</a> </li>
        <li><a href="/index.xml">Atom Feed</a> </li>
        <li><a href="https://github.com/sdqali">GitHub</a> </li>
        <li><a href="https://twitter.com/sdqali">Twitter</a> </li>
        <li><a href="https://www.linkedin.com/in/sdqali">LinkedIn</a> </li>
      </ul>
    </div>
    
  </div>
  
</nav>




    
    
    <header class="intro-header">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="site-heading">
              <h1> Injecting dependencies into a Spring @Configuration</h1>
              <span class="meta">Tue, Jun 28, 2016</span>
            </div>
          </div>
        </div>
      </div>
    </header>


    
    <article>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <p>This is one of those blog posts about things I wish I had known before I spent a lot of time figuring out when something was not working as expected. Recently, we have been trying to extend a <code>WebMvcConfigurerAdapter</code> to wire up an HTTP request interceptor. And things did not work as we expected it to and we learned that our understanding of how Spring behaved under this situation was wrong. This is a write up to refer back to if and when we encounter this issue again.</p>

<p></p>

<p>Spring&rsquo;s <code>@Configuration</code> annotation allows us to create a class that provides a set of beans. Because we wanted to wire up interceptors when the application started, it felt reasonable to annotate the extended <code>WebMvcConfigurerAdapter</code> adaptor as a <code>@Configuration</code>.</p>

<p>So we ended up with code that looked as follows:</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #9999FF">@Configuration</span>
<span style="color: #006699; font-weight: bold">public</span> <span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">Config</span> <span style="color: #006699; font-weight: bold">extends</span> WebMvcConfigurerAdapter <span style="color: #555555">{</span>
    <span style="color: #006699; font-weight: bold">private</span> HandlerInterceptor handlerInterceptor<span style="color: #555555">;</span>

    <span style="color: #9999FF">@SuppressWarnings</span><span style="color: #555555">(</span><span style="color: #CC3300">&quot;unused&quot;</span><span style="color: #555555">)</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #CC00FF">Config</span><span style="color: #555555">()</span> <span style="color: #555555">{</span>
    <span style="color: #555555">}</span>

    <span style="color: #9999FF">@Autowired</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #CC00FF">Config</span><span style="color: #555555">(</span>HandlerInterceptor handlerInterceptor<span style="color: #555555">)</span> <span style="color: #555555">{</span>
        <span style="color: #006699; font-weight: bold">this</span><span style="color: #555555">.</span><span style="color: #330099">handlerInterceptor</span> <span style="color: #555555">=</span> handlerInterceptor<span style="color: #555555">;</span>
    <span style="color: #555555">}</span>

    <span style="color: #9999FF">@Override</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">void</span> <span style="color: #CC00FF">addInterceptors</span><span style="color: #555555">(</span>InterceptorRegistry registry<span style="color: #555555">)</span> <span style="color: #555555">{</span>
        registry<span style="color: #555555">.</span><span style="color: #330099">addInterceptor</span><span style="color: #555555">(</span>handlerInterceptor<span style="color: #555555">);</span>
        <span style="color: #006699; font-weight: bold">super</span><span style="color: #555555">.</span><span style="color: #330099">addInterceptors</span><span style="color: #555555">(</span>registry<span style="color: #555555">);</span>
    <span style="color: #555555">}</span>
<span style="color: #555555">}</span>
</pre></div>

<p>The interceptor itself is declared a <code>@Component</code> of the following form:</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #9999FF">@Component</span>
<span style="color: #006699; font-weight: bold">public</span> <span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">SessionCheckInterceptor</span> <span style="color: #006699; font-weight: bold">implements</span> HandlerInterceptor <span style="color: #555555">{</span>

    <span style="color: #9999FF">@Override</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">boolean</span> <span style="color: #CC00FF">preHandle</span><span style="color: #555555">(</span>HttpServletRequest request<span style="color: #555555">,</span> HttpServletResponse response<span style="color: #555555">,</span> Object handler<span style="color: #555555">)</span> <span style="color: #006699; font-weight: bold">throws</span> Exception <span style="color: #555555">{</span>
        <span style="color: #006699; font-weight: bold">if</span><span style="color: #555555">(</span>request<span style="color: #555555">.</span><span style="color: #330099">getHeader</span><span style="color: #555555">(</span><span style="color: #CC3300">&quot;session&quot;</span><span style="color: #555555">)</span> <span style="color: #555555">==</span> <span style="color: #006699; font-weight: bold">null</span><span style="color: #555555">)</span> <span style="color: #555555">{</span>
            response<span style="color: #555555">.</span><span style="color: #330099">setStatus</span><span style="color: #555555">(</span>HttpServletResponse<span style="color: #555555">.</span><span style="color: #330099">SC_BAD_REQUEST</span><span style="color: #555555">);</span>
            <span style="color: #006699; font-weight: bold">return</span> <span style="color: #006699; font-weight: bold">false</span><span style="color: #555555">;</span>
        <span style="color: #555555">}</span> <span style="color: #006699; font-weight: bold">else</span> <span style="color: #555555">{</span>
            <span style="color: #006699; font-weight: bold">return</span> <span style="color: #006699; font-weight: bold">true</span><span style="color: #555555">;</span>
        <span style="color: #555555">}</span>
    <span style="color: #555555">}</span>

    <span style="color: #9999FF">@Override</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">void</span> <span style="color: #CC00FF">postHandle</span><span style="color: #555555">(</span>HttpServletRequest request<span style="color: #555555">,</span> HttpServletResponse response<span style="color: #555555">,</span> Object handler<span style="color: #555555">,</span> ModelAndView modelAndView<span style="color: #555555">)</span> <span style="color: #006699; font-weight: bold">throws</span> Exception <span style="color: #555555">{</span>

    <span style="color: #555555">}</span>

    <span style="color: #9999FF">@Override</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">void</span> <span style="color: #CC00FF">afterCompletion</span><span style="color: #555555">(</span>HttpServletRequest request<span style="color: #555555">,</span> HttpServletResponse response<span style="color: #555555">,</span> Object handler<span style="color: #555555">,</span> Exception ex<span style="color: #555555">)</span> <span style="color: #006699; font-weight: bold">throws</span> Exception <span style="color: #555555">{</span>

    <span style="color: #555555">}</span>
<span style="color: #555555">}</span>
</pre></div>

<p>As you can see, the interceptor checks every request for a <code>session</code> header and responds with a <code>BAD_REQUEST (400)</code> in the absence of it.</p>

<p>This code compiles fine, but when you run it, you will be confronted with the following stack trace:</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>Factory method <span style="color: #CC3300">&#39;requestMappingHandlerMapping&#39;</span> threw exception; nested exception is java.lang.IllegalArgumentException: Interceptor is required
</pre></div>

<p>So, what happened? Looking at the stack trace reveals the following:</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>Caused by: java.lang.IllegalArgumentException: Interceptor is required
    at org.springframework.util.Assert.notNull<span style="color: #555555">(</span>Assert.java:115<span style="color: #555555">)</span>
    at org.springframework.web.servlet.config.annotation.InterceptorRegistration.&lt;init&gt;<span style="color: #555555">(</span>InterceptorRegistration.java:51<span style="color: #555555">)</span>
    at org.springframework.web.servlet.config.annotation.InterceptorRegistry.addInterceptor<span style="color: #555555">(</span>InterceptorRegistry.java:45<span style="color: #555555">)</span>
    at in.sdqali.spring.config.Config.addInterceptors<span style="color: #555555">(</span>Config.java:30<span style="color: #555555">)</span>
</pre></div>

<p>Evidently, the interceptor we wired up is <code>null</code>. After a spending a lot of time on this, we discovered this line on the java doc for <code>@Configuration</code>:</p>

<pre><code>@Configuration is meta-annotated with @Component, therefore
@Configuration classes are candidates for component scanning (typically using
Spring XML's &lt;context:component-scan/&gt; element) and therefore may also take
advantage of @Autowired/@Inject
at the field and method level (but not at the constructor level).
</code></pre>

<p>A simple fix is to inject the interceptor through a setter as follows:</p>
<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #9999FF">@Configuration</span>
<span style="color: #006699; font-weight: bold">public</span> <span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">Config</span> <span style="color: #006699; font-weight: bold">extends</span> WebMvcConfigurerAdapter <span style="color: #555555">{</span>
    <span style="color: #006699; font-weight: bold">private</span> HandlerInterceptor handlerInterceptor<span style="color: #555555">;</span>

    <span style="color: #9999FF">@SuppressWarnings</span><span style="color: #555555">(</span><span style="color: #CC3300">&quot;unused&quot;</span><span style="color: #555555">)</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #CC00FF">Config</span><span style="color: #555555">()</span> <span style="color: #555555">{</span>
    <span style="color: #555555">}</span>

    <span style="color: #9999FF">@Autowired</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">void</span> <span style="color: #CC00FF">setHandlerInterceptor</span><span style="color: #555555">(</span>HandlerInterceptor handlerInterceptor<span style="color: #555555">)</span> <span style="color: #555555">{</span>
        <span style="color: #006699; font-weight: bold">this</span><span style="color: #555555">.</span><span style="color: #330099">handlerInterceptor</span> <span style="color: #555555">=</span> handlerInterceptor<span style="color: #555555">;</span>
    <span style="color: #555555">}</span>

    <span style="color: #9999FF">@Override</span>
    <span style="color: #006699; font-weight: bold">public</span> <span style="color: #007788; font-weight: bold">void</span> <span style="color: #CC00FF">addInterceptors</span><span style="color: #555555">(</span>InterceptorRegistry registry<span style="color: #555555">)</span> <span style="color: #555555">{</span>
        registry<span style="color: #555555">.</span><span style="color: #330099">addInterceptor</span><span style="color: #555555">(</span>handlerInterceptor<span style="color: #555555">);</span>
        <span style="color: #006699; font-weight: bold">super</span><span style="color: #555555">.</span><span style="color: #330099">addInterceptors</span><span style="color: #555555">(</span>registry<span style="color: #555555">);</span>
    <span style="color: #555555">}</span>
<span style="color: #555555">}</span>
</pre></div>

<p>It took us a lot of time debugging and stepping through Spring code before we finally figured out what the issue was, but we could have discovered it in seconds from the java doc. There is a lesson in there for us.</p>

<p>The example code to demonstrate this is available on <a href="https://github.com/sdqali/config-constructor-poc">GitHub</a>.</p>
            <p class="comments">
  If you have questions or comments about this blog post, you can get in touch with me on Twitter <a href="https://twitter.com/sdqali">@sdqali</a>.
</p>

          </div>
        </div>
      </div>
    </article>

    <hr>

    
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          <li>
            <a href="https://twitter.com/sdqali">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="https://linkedin.com/in/sdqali">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="https://github.com/sdqali">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="/index.xml">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
        </ul>
        <p class="copyright text-muted">&copy; All rights reserved.</p>
      </div>
    </div>
  </div>
</footer>


<script src="/js/jquery.js"></script>


<script src="/js/bootstrap.min.js"></script>


<script src="/js/clean-blog.min.js"></script>

<script src="http://sdqali.in/js/keen.min.3.3.0.js" type="text/javascript"></script>
<script src="http://sdqali.in/js/parseuri.js" type="text/javascript"></script>
<script src="http://sdqali.in/js/ua-parser.min.js" type="text/javascript
"></script>
 <script src="http://sdqali.in/js/Math.uuid.js" type="text/javascript"></script>
<script src="http://sdqali.in/js/analytics.js" type="text/javascript"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86967633-1', 'auto');
  ga('send', 'pageview');

</script>


  </body>
</html>
